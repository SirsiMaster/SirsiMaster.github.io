<!DOCTYPE html>
<!-- GitHub Pages Update: 2025-08-13 02:15 -->
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SirsiNexus - Secure Payment Portal</title>
    <meta name="description" content="Secure payment processing for SirsiNexus services - Professional AI-powered infrastructure solutions">
    <meta name="theme-color" content="#059669">
    <link rel="manifest" href="manifest.webmanifest?v=20250813-2">
    
    <!-- Favicons -->
    <link rel="icon" href="/sirsinexusportal/assets/images/sirsi-icon.png" type="image/png" sizes="32x32">
    <link rel="icon" href="/sirsinexusportal/assets/images/sirsi-icon-192.png" type="image/png" sizes="192x192">
    <link rel="icon" href="/sirsinexusportal/assets/images/sirsi-icon-512.png" type="image/png" sizes="512x512">
    <link rel="apple-touch-icon" href="/sirsinexusportal/assets/images/sirsi-icon-192.png" sizes="192x192">
    
    <!-- Preload critical resources -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Compiled Tailwind CSS -->
    <link rel="stylesheet" href="/sirsinexusportal/assets/css/tailwind.css?v=20250813-2">
    <!-- PayPal SDK with Apple Pay and alternative payment methods -->
    <script src="https://www.paypal.com/sdk/js?client-id=ASUI7q4yAs6anh26J6T_7hLyX0UwUbVWQS-8lgngn9z0W6VX4zrt2y7Q_auiXBAUrzxd1ibBrz22KDAr&currency=USD&components=buttons,marks,funding-eligibility&enable-funding=venmo,paylater,card&disable-funding=credit"></script>
    
    <!-- Google Pay SDK -->
    <script async src="https://pay.google.com/gp/p/js/pay.js" onload="typeof onGooglePayLoaded === 'function' && onGooglePayLoaded()"></script>
    
    <!-- QR Code Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    
    <!-- Security and privacy -->
    <meta name="robots" content="noindex, nofollow">
    <meta name="referrer" content="no-referrer">
    
    <!-- Fresh Theme Toggle -->
    <script>
      (function() {
        const savedTheme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const shouldBeDark = savedTheme ? savedTheme === 'dark' : prefersDark;
        
        if (shouldBeDark) {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
      })();
    </script>

    <style>
      /* Desktop polish: stabilize PayPal area to reduce layout shifts */
      #paypal-button-container { min-height: 60px; }
      /* Ensure payment method tiles are uniform width */
      .payment-grid \> * { width: 100%; }
      .payment-tile { width: 100%; display: block; border-radius: 0.75rem; overflow: hidden; }
      .payment-tile \> button, .payment-tile \> div { width: 100%; }
      /* Uniform payment rows to ensure identical widths for all methods */
      .payment-list { display: flex; flex-direction: column; gap: 0.75rem; }
      .payment-row { width: 100%; min-width: 0; }
      .payment-tile { min-width: 0; box-sizing: border-box; }
      /* Standardize ALL payment buttons to consistent dimensions and styling */
      .payment-btn { 
        height: 55px; 
        border-radius: 8px; 
        font-weight: 600; 
        font-size: 16px; 
        line-height: 1; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        width: 100%;
        border: 2px solid transparent;
        transition: all 0.2s ease;
        cursor: pointer;
      }
      .payment-btn span { font-weight: 700; }
      .payment-btn:hover { transform: translateY(-1px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
      .payment-btn:active { transform: translateY(0); }
      
      /* Payment button variants */
      .payment-btn--zelle { background: linear-gradient(90deg, #7c3aed, #6d28d9); color: #fff; }
      .payment-btn--zelle:hover { filter: brightness(1.05); }
      
      .payment-btn--apple { background-color: #000000; color: #fff; }
      .payment-btn--apple:hover { background-color: #1a1a1a; }
      
      .payment-btn--google { background-color: #ffffff; color: #333333; border-color: #dadce0; }
      .payment-btn--google:hover { background-color: #f8f9fa; border-color: #bdc1c6; }
      
      .payment-btn--paypal { background-color: #ffffff; color: #003087; border-color: #003087; }
      .payment-btn--paypal:hover { background-color: #f7f9fc; border-color: #0066cc; }
      
      /* Legacy support for existing pp-like-btn classes */
      .pp-like-btn { height: 55px; border-radius: 8px; font-weight: 600; font-size: 16px; line-height: 1; display: flex; align-items: center; justify-content: center; width: 100%; border: 2px solid transparent; transition: all 0.2s ease; cursor: pointer; }
      .pp-like-btn span { font-weight: 700; }
      .pp-like-btn:hover { transform: translateY(-1px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
      .pp-like-btn:active { transform: translateY(0); }
      .pp-like-btn--dark { background-color: #000000; color: #fff; }
      .pp-like-btn--dark:hover { background-color: #1a1a1a; }
      .pp-like-btn--light { background-color: #ffffff; color: #003087; border-color: #003087; }
      .pp-like-btn--light:hover { background-color: #f7f9fc; border-color: #0066cc; }
      .pp-like-btn--brand { background: linear-gradient(90deg, #7c3aed, #6d28d9); color: #fff; }
      .pp-like-btn--brand:hover { filter: brightness(1.05); }
      /* Ensure PayPal wrapper spans full width without fighting SDK layout (modal target) */
      #paypal-sdk-buttons, #paypal-button-container { width: 100%; }
      #paypal-sdk-buttons > div, #paypal-button-container > div {
        width: 100% !important;
        max-width: 100% !important;
      }
      /* Make PayPal buttons visually match the standardized 55px tiles */
      #paypal-sdk-buttons, #paypal-button-container { --pp-btn-height: 55px; }
      #paypal-sdk-buttons [data-funding-source], #paypal-button-container [data-funding-source] { 
        border-radius: 4px !important; 
        overflow: hidden !important; 
        min-height: var(--pp-btn-height) !important;
      }
      #paypal-sdk-buttons iframe, #paypal-button-container iframe { 
        min-height: var(--pp-btn-height) !important;
        width: 100% !important;
      }
      /* Optionally hide PayPal promotional message to keep rows even */
      [data-pp-message] { display: none !important; }
      /* SirsiNexus geometric patterns */
      .geometric-pattern {
        position: absolute;
        width: 100%;
        height: 100%;
        overflow: hidden;
        pointer-events: none;
      }
      
      .hex-pattern {
        position: absolute;
        width: 100%;
        height: 100%;
        background-image: 
          url('data:image/svg+xml,<svg width="100" height="86.6" xmlns="http://www.w3.org/2000/svg"><polygon points="50,0 100,25 100,61.6 50,86.6 0,61.6 0,25" fill="none" stroke="rgba(16,185,129,0.1)" stroke-width="1"/></svg>');
        background-size: 100px 86.6px;
        opacity: 0.3;
      }

      .payment-glow {
        box-shadow: 0 0 40px rgba(16, 185, 129, 0.1);
      }

      .payment-glow:hover {
        box-shadow: 0 0 60px rgba(16, 185, 129, 0.15);
      }
      
      /* Mobile optimization */
      @media (max-width: 480px) {
        .progress-mobile {
          flex-direction: column;
          gap: 1rem;
        }
        .progress-mobile .w-8 {
          display: none;
        }
        .mobile-stack {
          flex-direction: column;
          align-items: center;
          text-align: center;
        }
      }
      
      /* Prevent horizontal scroll on very small screens */
      html, body {
        overflow-x: hidden;
      }
      
      .container-safe {
        max-width: 100vw;
        overflow-x: hidden;
      }

      /* Shared card utility (works without Tailwind build) */
      .sirsi-card {
        background-color: #ffffff; /* light bg */
        border: 1px solid rgb(226 232 240); /* slate-200 */
        border-radius: 1rem; /* rounded-2xl (approx) */
        box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); /* shadow-xl */
        overflow: hidden;
        width: 100%; /* w-full */
        box-sizing: border-box; /* box-border */
        margin-left: auto; /* center horizontally */
        margin-right: auto; /* center horizontally */
      }
      .dark .sirsi-card {
        background-color: rgb(30 41 59); /* slate-800 */
        border-color: rgb(51 65 85); /* slate-700 */
        color: inherit;
      }

      /* Responsive card max-widths for uniform layout */
      @media (min-width: 640px) { /* sm */
        .sirsi-card { max-width: 42rem; }
      }
      @media (min-width: 768px) { /* md */
        .sirsi-card { max-width: 48rem; }
      }
      @media (min-width: 1024px) { /* lg */
        .sirsi-card { max-width: 56rem; }
      }
      
      /* Unified Payment Button System - All buttons have identical dimensions */
      .unified-payment-btn {
        height: 60px;
        width: 100%;
        border-radius: 12px;
        font-weight: 600;
        font-size: 16px;
        line-height: 1;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
        border: 2px solid transparent;
        transition: all 0.15s ease;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      
      .unified-payment-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }
      
      .unified-payment-btn:active {
        transform: translateY(0);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      
      /* Payment method specific colors */
      .unified-payment-btn--zelle {
        background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
        color: white;
      }
      
      .unified-payment-btn--zelle:hover {
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
      }
      
      .unified-payment-btn--apple {
        background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
        color: white;
      }
      
      .unified-payment-btn--apple:hover {
        background: linear-gradient(135deg, #1a1a1a 0%, #333333 100%);
      }
      
      .unified-payment-btn--google {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        color: #333333;
        border-color: #dadce0;
      }
      
      .unified-payment-btn--google:hover {
        background: linear-gradient(135deg, #f8f9fa 0%, #e8eaed 100%);
        border-color: #bdc1c6;
      }
      
      .unified-payment-btn--paypal {
        background: linear-gradient(135deg, #ffffff 0%, #f7f9fc 100%);
        color: #0070ba;
        border-color: #0070ba;
      }
      
      .unified-payment-btn--paypal:hover {
        background: linear-gradient(135deg, #f7f9fc 0%, #e6f4ff 100%);
        border-color: #0066cc;
      }
      
      .unified-payment-btn--card {
        background: linear-gradient(135deg, #ffffff 0%, #f5f5f7 100%);
        color: #1d1d1f;
        border-color: #d2d2d7;
      }
      
      .unified-payment-btn--card:hover {
        background: linear-gradient(135deg, #f5f5f7 0%, #ebebef 100%);
        border-color: #a1a1aa;
      }
      
      .unified-payment-btn--venmo {
        background: linear-gradient(135deg, #3d95ce 0%, #1e3a8a 100%);
        color: white;
      }
      
      .unified-payment-btn--venmo:hover {
        background: linear-gradient(135deg, #60a5fa 0%, #3d95ce 100%);
      }
      
      /* Dark mode adjustments */
      .dark .unified-payment-btn--google {
        background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
        color: #f3f4f6;
        border-color: #6b7280;
      }
      
      .dark .unified-payment-btn--google:hover {
        background: linear-gradient(135deg, #4b5563 0%, #6b7280 100%);
        border-color: #9ca3af;
      }
      
      .dark .unified-payment-btn--paypal {
        background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
        color: #60a5fa;
        border-color: #60a5fa;
      }
      
      .dark .unified-payment-btn--paypal:hover {
        background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
        border-color: #3b82f6;
      }
      
      .dark .unified-payment-btn--card {
        background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
        color: #f3f4f6;
        border-color: #6b7280;
      }
      
      .dark .unified-payment-btn--card:hover {
        background: linear-gradient(135deg, #4b5563 0%, #6b7280 100%);
        border-color: #9ca3af;
      }
    </style>
</head>
<body class="font-inter bg-gradient-to-br from-slate-50 via-emerald-50/30 to-slate-50 dark:from-slate-900 dark:via-emerald-900/20 dark:to-slate-900 text-slate-900 dark:text-slate-100 min-h-screen">
    <!-- Professional Header with Sirsi Branding -->
    <header class="bg-white dark:bg-slate-800/95 sticky top-0 z-50 border-b border-slate-200 dark:border-slate-700 backdrop-blur-sm">
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex h-16 items-center justify-between">
          <div class="flex items-center gap-6">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 flex items-center justify-center">
                <img src="/sirsinexusportal/assets/images/Sirsi_Logo_300ppi_cguiyg.png" alt="Sirsi Logo" class="w-12 h-12 object-contain dark:hidden">
                <img src="/sirsinexusportal/assets/images/Sirsi_Logo_300ppi_Inverted_lt7asx.png" alt="Sirsi Logo" class="w-12 h-12 object-contain hidden dark:block">
              </div>
              <div>
                <h1 class="text-lg font-semibold text-slate-900 dark:text-slate-100">
                  SirsiNexus
                </h1>
                <div class="flex items-center gap-2">
                  <span class="text-xs text-slate-500 dark:text-slate-400 bg-slate-100 dark:bg-slate-800 px-2 py-0.5 rounded">
                    Payment Portal
                  </span>
                  <div class="flex items-center gap-1">
                    <div class="w-1.5 h-1.5 bg-emerald-500 rounded-full"></div>
                    <span class="text-xs text-slate-600 dark:text-slate-300">Secure</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <nav class="flex items-center gap-4">
            <a href="/sirsinexusportal/index.html" class="text-sm text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-slate-100 transition-colors">Home</a>
            
            <!-- Admin Navigation - Only visible when accessing from admin portal -->
            <div id="admin-nav" class="flex items-center gap-4">
              <a href="/sirsinexusportal/admin/create-invoice.html" class="text-sm text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-slate-100 transition-colors">Invoice Creator</a>
              <a href="/sirsinexusportal/admin/revenue-dashboard.html" class="text-sm text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-slate-100 transition-colors">Revenue Dashboard</a>
              <a href="/sirsinexusportal/admin/index.html" class="text-sm text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-slate-100 transition-colors">Admin Dashboard</a>
              <button id="admin-logout-btn" class="text-sm text-red-600 dark:text-red-400 hover:text-red-700 dark:hover:text-red-300 transition-colors" onclick="adminLogout()">Logout</button>
            </div>
            
            <button id="theme-toggle" class="p-2 text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-colors border border-slate-300 dark:border-slate-600" title="Toggle theme">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
              </svg>
            </button>
          </nav>
        </div>
      </div>
    </header>

    <!-- Payment Portal Section -->
    <section class="relative py-8 min-h-screen bg-slate-50 dark:bg-slate-900">
      
      <div class="max-w-5xl lg:max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 relative z-10">
        
        <!-- Header -->
        <div class="text-center mb-12">
          <div class="w-20 h-20 bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-2xl flex items-center justify-center mx-auto mb-6">
            <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
            </svg>
          </div>
          <h1 class="text-4xl lg:text-5xl font-bold text-slate-900 dark:text-slate-100 mb-4">Secure Payment Portal</h1>
          <p class="text-xl text-slate-600 dark:text-slate-400 max-w-2xl mx-auto">Complete your payment in three simple steps</p>
        </div>
        
        <!-- Progress Indicator -->
        <div class="flex justify-center mb-16">
          <div class="flex items-center space-x-2 sm:space-x-4 md:space-x-8">
            <div class="flex items-center">
              <div class="w-8 h-8 sm:w-10 sm:h-10 bg-emerald-600 text-white rounded-full flex items-center justify-center font-semibold text-xs sm:text-sm">
                1
              </div>
              <span class="ml-2 sm:ml-3 text-xs sm:text-sm font-medium text-slate-900 dark:text-slate-100">Account</span>
            </div>
            <div class="w-8 sm:w-12 md:w-16 h-0.5 bg-slate-300 dark:bg-slate-600"></div>
            <div class="flex items-center">
              <div class="w-8 h-8 sm:w-10 sm:h-10 bg-emerald-600 text-white rounded-full flex items-center justify-center font-semibold text-xs sm:text-sm">
                2
              </div>
              <span class="ml-2 sm:ml-3 text-xs sm:text-sm font-medium text-slate-900 dark:text-slate-100">Details</span>
            </div>
            <div class="w-8 sm:w-12 md:w-16 h-0.5 bg-slate-300 dark:bg-slate-600"></div>
            <div class="flex items-center">
              <div class="w-8 h-8 sm:w-10 sm:h-10 bg-emerald-600 text-white rounded-full flex items-center justify-center font-semibold text-xs sm:text-sm">
                3
              </div>
              <span class="ml-2 sm:ml-3 text-xs sm:text-sm font-medium text-slate-900 dark:text-slate-100">Payment</span>
            </div>
          </div>
        </div>
        
        <!-- Step 1: Account Information Card -->
        <div id="account-section" class="sirsi-card mb-8">
          <div id="registration-section" class="p-6 lg:p-8">
            <div class="flex items-center gap-4 mb-6">
              <div class="w-12 h-12 bg-emerald-600 text-white rounded-full flex items-center justify-center font-semibold text-lg">1</div>
              <h2 class="text-2xl font-bold text-slate-900 dark:text-slate-100">Account Information</h2>
            </div>
            
              <!-- Welcome Back Message (conditionally shown) -->
              <div id="welcome-back-message" class="mb-6 p-4 bg-emerald-50 dark:bg-emerald-900/20 rounded-lg border border-emerald-200 dark:border-emerald-700">
                <div class="flex items-center gap-3">
                  <div class="w-10 h-10 bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-full flex items-center justify-center flex-shrink-0">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                  </div>
                  <div class="flex-1">
                    <h3 class="font-semibold text-emerald-900 dark:text-emerald-100">Welcome back, <span id="welcome-back-name"></span>!</h3>
                    <p class="text-sm text-emerald-700 dark:text-emerald-200">Your account is linked and ready. <button onclick="logoutAndReload()" class="text-emerald-600 dark:text-emerald-400 hover:underline">Not you?</button></p>
                  </div>
                </div>
              </div>
            
              <!-- Registration Form -->
              <form id="registration-form" class="space-y-4">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <div class="sm:col-span-2">
                    <label for="reg-email" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Email Address *</label>
                    <input type="email" id="reg-email" required class="w-full px-4 py-3 text-sm border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 dark:bg-slate-700 dark:text-white" placeholder="your@email.com">
                  </div>
                  <div>
                    <label for="reg-first-name" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">First Name *</label>
                    <input type="text" id="reg-first-name" required class="w-full px-4 py-3 text-sm border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 dark:bg-slate-700 dark:text-white" placeholder="John">
                  </div>
                  <div>
                    <label for="reg-last-name" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Last Name</label>
                    <input type="text" id="reg-last-name" class="w-full px-4 py-3 text-sm border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 dark:bg-slate-700 dark:text-white" placeholder="Doe">
                  </div>
                </div>
                
                <div class="flex items-start gap-3 pt-2">
                  <input type="checkbox" id="reg-terms" required class="mt-1 w-4 h-4 text-emerald-600 border-slate-300 rounded focus:ring-emerald-500">
                  <label for="reg-terms" class="text-sm text-slate-600 dark:text-slate-400">
                    I agree to the <a href="/sirsinexusportal/terms.html" class="text-emerald-600 dark:text-emerald-400 hover:underline" target="_blank">Terms</a> and <a href="/sirsinexusportal/privacy.html" class="text-emerald-600 dark:text-emerald-400 hover:underline" target="_blank">Privacy Policy</a>
                  </label>
                </div>
                
                <div id="registration-form-actions" class="flex gap-3 pt-4">
                  <button type="button" onclick="skipRegistration()" class="flex-1 bg-slate-100 dark:bg-slate-600 text-slate-700 dark:text-slate-200 py-3 px-4 rounded-lg font-medium hover:bg-slate-200 dark:hover:bg-slate-500 transition-all text-sm">
                    Continue as Guest
                  </button>
                  <button type="submit" class="flex-1 bg-gradient-to-r from-emerald-600 to-emerald-700 text-white py-3 px-4 rounded-lg font-medium hover:from-emerald-700 hover:to-emerald-800 transition-all text-sm">
                    Create Account
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
        
        <!-- Step 2: Payment Details Card -->
        <div class="sirsi-card mb-8">
          <div class="p-6 lg:p-8">
            <div class="flex items-center gap-4 mb-6">
              <div class="w-12 h-12 bg-emerald-600 text-white rounded-full flex items-center justify-center font-semibold text-lg">2</div>
              <h2 class="text-2xl font-bold text-slate-900 dark:text-slate-100">Payment Details</h2>
            </div>
              
              <!-- Invoice Section (only visible when invoice exists) -->
              <div id="invoice-section" class="mb-6 w-full box-border" style="display: none;">
                <div class="bg-blue-50 dark:bg-blue-900/20 rounded-xl p-6 mb-4 border border-blue-200 dark:border-blue-700 box-border">
                  <div class="flex flex-col gap-4">
                    <div class="flex items-start justify-between gap-6">
                      <div class="flex items-start gap-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center flex-shrink-0">
                          <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                          </svg>
                        </div>
                        <div>
                          <h3 class="font-semibold text-blue-900 dark:text-blue-100">Invoice Payment</h3>
                          <div class="text-sm text-blue-700 dark:text-blue-200" id="invoice-number"></div>
                          <div class="mt-2 grid grid-cols-1 sm:grid-cols-3 gap-2 text-sm">
                            <div><span class="text-slate-600 dark:text-slate-400 font-medium">Service:</span> <span class="text-slate-900 dark:text-slate-100 font-semibold" id="invoice-service"></span></div>
                            <div><span class="text-slate-600 dark:text-slate-400 font-medium">Client:</span> <span class="text-slate-900 dark:text-slate-100 font-semibold" id="invoice-client"></span></div>
                            <div><span class="text-slate-600 dark:text-slate-400 font-medium">Date:</span> <span class="text-slate-900 dark:text-slate-100 font-semibold" id="invoice-date"></span></div>
                          </div>
                        </div>
                      </div>
                      <div class="text-right">
                        <div class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Invoice Amount</div>
                        <div class="text-2xl font-extrabold text-slate-900 dark:text-slate-100" id="invoice-amount">$0.00</div>
                      </div>
                    </div>

                    <div class="border-t border-slate-200 dark:border-slate-600"></div>

                    <div class="grid md:grid-cols-2 gap-4">
                      <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Payment Amount (USD) *</label>
                        <div class="relative">
                          <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 text-lg font-medium">$</span>
                          <input type="number" id="invoice-payment-amount" step="0.01" class="pl-10 w-full px-4 py-3 text-lg border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 dark:bg-slate-700 dark:text-white transition-colors" placeholder="0.00">
                        </div>
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Description (Optional)</label>
                        <input type="text" id="invoice-payment-description" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 dark:bg-slate-700 dark:text-white" placeholder="What is this payment for?">
                      </div>
                    </div>

                    <p class="text-xs text-slate-600 dark:text-slate-400">Minimum payment: <span id="invoice-minimum"></span>. You can pay more than the invoice amount (tip, overpayment), but not less.</p>

                    <!-- Invoice Fee Breakdown -->
                    <div id="invoice-fee-breakdown" class="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-xl p-4 w-full box-border" style="display: none;">
                      <div class="flex items-start gap-3">
                        <div class="bg-amber-600 rounded-lg p-2 flex-shrink-0">
                          <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                          </svg>
                        </div>
                        <div class="flex-1">
                          <h5 class="font-semibold text-amber-900 dark:text-amber-100 mb-2">Payment Processing Fees</h5>
                          <div id="invoice-fee-details" class="space-y-2 text-sm"></div>
                          <div class="border-t border-amber-300 dark:border-amber-700 pt-3 mt-3">
                            <div class="flex justify-between items-center text-sm font-medium"><span class="text-amber-900 dark:text-amber-100">Subtotal:</span><span id="invoice-fee-subtotal" class="text-amber-900 dark:text-amber-100">$0.00</span></div>
                            <div class="flex justify-between items-center text-sm font-medium"><span class="text-amber-900 dark:text-amber-100">Processing Fee:</span><span id="invoice-fee-amount" class="text-amber-900 dark:text-amber-100">$0.00</span></div>
                            <div class="flex justify-between items-center text-xl font-bold border-t border-amber-400 dark:border-amber-600 pt-2 mt-2"><span class="text-amber-900 dark:text-amber-100">Total to Pay:</span><span id="invoice-fee-total" class="text-amber-900 dark:text-amber-100">$0.00</span></div>
                          </div>
                          <div class="mt-3 text-xs text-amber-700 dark:text-amber-300 bg-amber-100 dark:bg-amber-900/30 rounded-lg p-2"><strong>Note:</strong> This covers most PayPal payment methods including credit cards, PayPal accounts, and alternative payment methods.</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              
              <!-- Custom Payment Section (when no invoice) -->
              <div id="custom-payment-section" class="w-full box-border" style="display: block;">
                <div class="text-center mb-8">
                  <h3 class="text-xl font-bold text-slate-800 dark:text-slate-200 mb-2">Make a Payment</h3>
                  <p class="text-slate-600 dark:text-slate-400">Enter your payment details below</p>
                </div>
                
                <!-- Payment Details Form -->
                <div class="bg-slate-50 dark:bg-slate-700/50 rounded-xl p-6 mb-6 box-border">
                  <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">Payment Details</h4>
                  <div class="space-y-4 md:space-y-0 md:grid md:grid-cols-2 md:gap-4">
                    <div>
                      <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Payment Amount (USD) *</label>
                      <div class="relative">
                        <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-slate-500 text-lg font-medium">$</span>
                        <input type="number" id="payment-amount" min="1" max="10000" step="0.01" 
                               class="pl-10 w-full px-4 py-3 text-lg border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 dark:bg-slate-700 dark:text-white transition-all shadow-sm"
                               placeholder="0.00">
                      </div>
                    </div>
                    
                    <div>
                      <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Description (Optional)</label>
                      <input type="text" id="payment-description" 
                             class="w-full px-4 py-3 text-base border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 dark:bg-slate-700 dark:text-white transition-all shadow-sm"
                             placeholder="What is this payment for?">
                    </div>
                  </div>
                </div>
              </div>
              
            </div>
          </div>
        </div>
        
        <!-- Step 3: Choose Payment Method Card -->
        <div id="payment-method-card" class="sirsi-card mb-8">
          <div class="p-6 lg:p-8">
            <div class="flex items-center gap-4 mb-2">
              <div class="w-12 h-12 bg-emerald-600 text-white rounded-full flex items-center justify-center font-semibold text-lg">3</div>
              <h2 class="text-2xl font-bold text-slate-900 dark:text-slate-100">Choose Payment Method</h2>
            </div>
            <p class="text-slate-600 dark:text-slate-400 mb-6">Select your preferred way to pay</p>

            <!-- Clean Payment Methods Grid -->
            <div class="space-y-3">
              
              <!-- Zelle Payment Button -->
              <div class="w-full">
                <button id="zelle-pay-btn" type="button" 
                        class="unified-payment-btn unified-payment-btn--zelle"
                        onclick="showZelleDetails()">
                  <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center flex-shrink-0">
                      <span class="text-sm font-bold leading-none">Z</span>
                    </div>
                    <span class="font-semibold">Pay with Zelle® — No Fees!</span>
                  </div>
                  <div class="px-2 py-1 bg-white/20 rounded text-xs font-medium">Instant</div>
                </button>
              </div>

              <!-- Apple Pay Button -->
              <div class="w-full">
                <button id="apple-pay-btn" type="button"
                        class="unified-payment-btn unified-payment-btn--apple"
                        onclick="handleApplePay('qr')">
                  <div class="flex items-center gap-3">
                    <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
                    </svg>
                    <span class="font-semibold">Pay with Apple Pay</span>
                  </div>
                  <div class="px-2 py-1 bg-white/20 rounded text-xs font-medium">QR Code</div>
                </button>
              </div>

              <!-- Google Pay Button -->
              <div class="w-full">
                <button id="google-pay-btn" type="button"
                        class="unified-payment-btn unified-payment-btn--google"
                        onclick="handleGooglePay()">
                  <div class="flex items-center gap-3">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                      <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                      <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                      <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    <span class="font-semibold">Pay with Google Pay</span>
                  </div>
                  <div class="px-2 py-1 bg-slate-600/10 rounded text-xs font-medium">Cards</div>
                </button>
              </div>

              <!-- PayPal Button -->
              <div class="w-full">
                <button id="paypal-launch-btn" type="button"
                        class="unified-payment-btn unified-payment-btn--paypal"
                        onclick="openPayPalModal()">
                  <div class="flex items-center gap-3">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                      <path d="M4 12a8 8 0 1 1 16 0 8 8 0 0 1-16 0Z" fill="#0070ba"/>
                      <path d="M8 13.5h5.2c1.8 0 2.8-.8 2.8-2.3 0-1.4-1.1-2.2-2.7-2.2H9.3L8 13.5Z" fill="#fff"/>
                    </svg>
                    <span class="font-semibold">PayPal, Venmo & Cards</span>
                  </div>
                  <div class="px-2 py-1 bg-blue-600/10 rounded text-xs font-medium">All Cards</div>
                </button>
              </div>

              <!-- Credit/Debit Card Button -->
              <div class="w-full">
                <button id="card-direct-btn" type="button"
                        class="unified-payment-btn unified-payment-btn--card"
                        onclick="openPayPalModal()">
                  <div class="flex items-center gap-3">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                    </svg>
                    <span class="font-semibold">Credit or Debit Card</span>
                  </div>
                  <div class="px-2 py-1 bg-gray-600/10 rounded text-xs font-medium">Direct</div>
                </button>
              </div>

              <!-- Venmo Button -->
              <div class="w-full">
                <button id="venmo-direct-btn" type="button"
                        class="unified-payment-btn unified-payment-btn--venmo"
                        onclick="openPayPalModal()">
                  <div class="flex items-center gap-3">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M19.48 3c.73 3.21.89 6.05-.01 8.82-1.64 5.13-4.51 8.18-8.31 8.18-1.75 0-3.26-1.16-3.26-3.26 0-.89.31-2.06.89-3.54l2.93-9.2h4.28l-2.7 8.51c-.31.99-.47 1.75-.47 2.38 0 .68.31 1.06.84 1.06 1.43 0 2.64-2.33 3.43-5.18.68-2.49.68-4.97.16-7.77H19.48z"/>
                    </svg>
                    <span class="font-semibold">Pay with Venmo</span>
                  </div>
                  <div class="px-2 py-1 bg-blue-600/10 rounded text-xs font-medium">Social</div>
                </button>
              </div>

            </div>

            <!-- Fee Breakdown (shown when applicable) -->
            <div id="fee-breakdown" class="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-xl p-4 mt-4 w-full" style="display: none;">
              <div class="flex items-start gap-3">
                <div class="bg-amber-600 rounded-lg p-2 flex-shrink-0">
                  <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/>
                  </svg>
                </div>
                <div class="flex-1">
                  <h4 class="font-semibold text-amber-900 dark:text-amber-100 mb-2">Payment Processing Fees</h4>
                  <p class="text-amber-800 dark:text-amber-200 text-sm mb-3">The following fees will be added to cover payment processing costs:</p>
                  <div id="fee-details" class="space-y-2 text-sm"></div>
                  <div class="border-t border-amber-300 dark:border-amber-700 pt-3 mt-3">
                    <div class="flex justify-between items-center text-sm font-medium">
                      <span class="text-amber-900 dark:text-amber-100">Subtotal:</span>
                      <span id="fee-subtotal" class="text-amber-900 dark:text-amber-100">$0.00</span>
                    </div>
                    <div class="flex justify-between items-center text-sm font-medium">
                      <span class="text-amber-900 dark:text-amber-100">Processing Fee:</span>
                      <span id="fee-amount" class="text-amber-900 dark:text-amber-100">$0.00</span>
                    </div>
                    <div class="flex justify-between items-center text-base font-bold border-t border-amber-400 dark:border-amber-600 pt-2 mt-2">
                      <span class="text-amber-900 dark:text-amber-100">Total to Pay:</span>
                      <span id="fee-total" class="text-amber-900 dark:text-amber-100">$0.00</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Zelle Details (collapsible) -->
            <div id="zelle-details" class="bg-purple-50 dark:bg-purple-900/20 rounded-xl p-6 mt-4 border border-purple-200 dark:border-purple-700" style="display: none;">
              <div class="flex items-center gap-6 mb-4">
                <div class="flex-shrink-0">
                  <img src="/sirsinexusportal/assets/images/zelle-qr.png" alt="Zelle QR Code" class="w-32 h-32 object-contain rounded-lg border border-purple-300 shadow-sm" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                  <div class="w-32 h-32 bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg flex items-center justify-center text-white shadow-lg" style="display:none;">
                    <div class="text-center">
                      <div class="text-2xl font-bold mb-1">Z</div>
                      <div class="text-sm opacity-90">QR Code</div>
                    </div>
                  </div>
                </div>
                <div class="flex-1">
                  <h3 class="text-lg font-bold text-purple-900 dark:text-purple-100 mb-2">Zelle® Payment Instructions</h3>
                  <p class="text-sm text-purple-700 dark:text-purple-200 mb-3">Scan the QR code with your banking app or send payment to:</p>
                  <div class="bg-purple-100 dark:bg-purple-900/50 rounded-lg p-3 mb-3">
                    <p class="font-mono font-bold text-purple-900 dark:text-purple-100 text-center text-lg">cylton@cylton.com</p>
                  </div>
                  <div class="grid grid-cols-3 gap-2 text-xs">
                    <div class="bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200 px-2 py-1 rounded text-center font-medium">✓ Instant</div>
                    <div class="bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200 px-2 py-1 rounded text-center font-medium">✓ Secure</div>
                    <div class="bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200 px-2 py-1 rounded text-center font-medium">✓ No Fees</div>
                  </div>
                </div>
              </div>
              <div class="text-center">
                <button type="button" onclick="copyZelleInfo()" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-xl transition-all shadow-lg hover:shadow-xl">
                  📋 Copy Payment Info
                </button>
              </div>
            </div>

            <!-- Status area -->
            <div id="payment-message" class="text-center text-base mt-6 min-h-[1.25rem]"></div>

            <!-- PayPal Modal -->
            <div id="paypal-modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">
              <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 w-full max-w-md mx-4 shadow-2xl">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="text-lg font-semibold text-slate-900 dark:text-slate-100">Complete Your Payment</h3>
                  <button class="text-slate-500 hover:text-slate-700 text-xl" onclick="closePayPalModal()" aria-label="Close">✕</button>
                </div>
                <div id="paypal-sdk-buttons" class="w-full"></div>
                <div id="paypal-modal-message" class="mt-3 text-center text-sm"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Support Section -->
        <div class="mt-12 text-center">
          <div class="bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-800 dark:to-slate-700 rounded-2xl p-8 lg:p-10 shadow-lg border border-slate-200 dark:border-slate-600">
            <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center mx-auto mb-6">
              <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
            <h3 class="text-2xl lg:text-3xl font-bold text-slate-900 dark:text-slate-100 mb-4">Need Help?</h3>
            <p class="text-slate-600 dark:text-slate-400 text-lg mb-6 max-w-2xl mx-auto">
              Our support team is here to assist you with any payment questions or technical issues.
            </p>
            <a href="mailto:cylton@cylton.com" class="inline-flex items-center gap-3 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-4 px-8 rounded-xl transition-all shadow-lg hover:shadow-xl">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
              </svg>
              Contact Support
            </a>
          </div>
        </div>
      </div>
      
      <!-- Background Effects -->
      <div class="absolute top-0 left-0 w-full h-full pointer-events-none">
        <div class="absolute top-20 left-20 w-64 h-64 bg-emerald-500/5 rounded-full blur-3xl"></div>
        <div class="absolute bottom-20 right-20 w-96 h-96 bg-blue-500/5 rounded-full blur-3xl"></div>
      </div>
    </section>

    <!-- Success Modal -->
    <div id="success-modal" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50" style="display: none;">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-8 max-w-md mx-4">
            <div class="text-center">
                <i class="fas fa-check-circle text-5xl text-green-500 mb-4"></i>
                <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">Payment Successful!</h3>
                <p class="text-gray-600 dark:text-gray-300 mb-4">Thank you for your payment. A receipt has been sent to your email.</p>
                <button onclick="closeSuccessModal()" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-6 rounded-md">
                    Close
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentInvoice = null;
        let currentAmount = 0;
        let currentDescription = '';
        let googlePayClient = null;
        let currentFeeAmount = 0;
        let currentTotalAmount = 0;
        let currentUser = null;
        let currentSession = null;
        let registrationRequired = false;
        
        // SirsiNexus Comprehensive Account Management System
        class SirsiAccountManager {
            constructor() {
                this.sessionId = this.generateSessionId();
                this.initializeSession();
                this.initializeProjectManagement();
            }
            
            generateUserId() {
                return 'USR-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9).toUpperCase();
            }
            
            generateAccountId() {
                return 'ACC-' + Date.now() + '-' + Math.random().toString(36).substr(2, 12).toUpperCase();
            }
            
            generateSessionId() {
                return 'SES-' + Date.now() + '-' + Math.random().toString(36).substr(2, 12).toUpperCase();
            }
            
            generateTransactionId() {
                return 'TXN-' + Date.now() + '-' + Math.random().toString(36).substr(2, 15).toUpperCase();
            }
            
            generateProjectId() {
                return 'PRJ-' + Date.now() + '-' + Math.random().toString(36).substr(2, 10).toUpperCase();
            }
            
            generateInvoiceId() {
                return 'INV-' + Date.now() + '-' + Math.random().toString(36).substr(2, 8).toUpperCase();
            }
            
            initializeSession() {
                this.sessionData = {
                    sessionId: this.sessionId,
                    startTime: new Date().toISOString(),
                    userAgent: navigator.userAgent,
                    ip: 'CLIENT_IP', // Would be populated server-side
                    platform: navigator.platform,
                    language: navigator.language,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    referrer: document.referrer || 'direct',
                    url: window.location.href,
                    deviceFingerprint: this.generateDeviceFingerprint(),
                    geoLocation: 'USER_LOCATION' // Would be populated with user permission
                };
                
                console.log('Payment session initialized:', this.sessionId);
            }
            
            generateDeviceFingerprint() {
                // Create a basic device fingerprint for security
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                ctx.textBaseline = 'top';
                ctx.font = '14px Arial';
                ctx.fillText('Device fingerprint', 2, 2);
                
                return btoa(JSON.stringify({
                    screen: `${screen.width}x${screen.height}`,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    language: navigator.language,
                    platform: navigator.platform,
                    cookieEnabled: navigator.cookieEnabled,
                    canvas: canvas.toDataURL().slice(22, 50)
                }));
            }
            
            initializeProjectManagement() {
                // Initialize project context based on invoice or URL params
                const urlParams = new URLSearchParams(window.location.search);
                const projectParam = urlParams.get('project');
                const invoiceParam = urlParams.get('invoice');
                
                if (projectParam) {
                    this.currentProject = this.getOrCreateProject(projectParam);
                } else if (invoiceParam && currentInvoice) {
                    // Create/get project based on invoice service
                    this.currentProject = this.getOrCreateProject(null, currentInvoice);
                } else {
                    // Default project for ad-hoc payments
                    this.currentProject = this.getOrCreateProject('general-services');
                }
                
                console.log('Project context initialized:', this.currentProject?.projectId);
            }
            
            createAccount(accountData) {
                const userId = this.generateUserId();
                const accountId = this.generateAccountId();
                
                // Validate required fields
                if (!accountData.email || !accountData.firstName) {
                    throw new Error('Email and first name are required for account creation');
                }
                
                const account = {
                    userId: userId,
                    accountId: accountId,
                    accountType: accountData.accountType || 'guest',
                    profile: {
                        firstName: accountData.firstName || '',
                        lastName: accountData.lastName || '',
                        email: accountData.email || '',
                        phone: accountData.phone || '',
                        company: accountData.company || '',
                        address: accountData.address || {},
                        customerSince: new Date().toISOString(),
                        preferredCurrency: 'USD',
                        timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
                    },
                    businessInfo: {
                        taxId: accountData.taxId || '',
                        businessType: accountData.businessType || 'individual',
                        industry: accountData.industry || '',
                        website: accountData.website || ''
                    },
                    metadata: {
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString(),
                        createdFrom: 'payment_portal',
                        sessionId: this.sessionId,
                        ipAddress: 'CLIENT_IP', // Would be populated server-side
                        source: currentInvoice ? 'invoice' : 'custom_payment',
                        deviceFingerprint: this.sessionData.deviceFingerprint,
                        creationContext: {
                            userAgent: navigator.userAgent,
                            referrer: document.referrer,
                            landingPage: window.location.href
                        }
                    },
                    preferences: {
                        emailNotifications: true,
                        paymentReminders: true,
                        marketingEmails: false,
                        preferredPaymentMethod: null,
                        language: navigator.language.split('-')[0],
                        communicationFrequency: 'normal'
                    },
                    security: {
                        twoFactorEnabled: false,
                        lastLoginAt: new Date().toISOString(),
                        passwordLastChanged: null,
                        securityQuestions: []
                    },
                    billing: {
                        preferredCurrency: 'USD',
                        billingAddress: accountData.address || {},
                        paymentMethods: [],
                        creditLimit: 0,
                        currentBalance: 0
                    },
                    projects: [], // Associated project IDs
                    transactionHistory: [], // Transaction IDs
                    invoiceHistory: [], // Invoice IDs
                    status: 'active',
                    compliance: {
                        kycStatus: 'pending',
                        riskLevel: 'low',
                        sanctionsCheck: 'passed',
                        dataRetentionConsent: true
                    }
                };
                
                // Store account (in production, this would be sent to server)
                this.storeAccount(account);
                currentUser = account;
                
                console.log('Account created:', userId, accountId);
                return account;
            }
            
            createRegisteredAccount(userData) {
                return this.createAccount({
                    accountType: 'registered',
                    email: userData.email,
                    firstName: userData.firstName,
                    lastName: userData.lastName || '',
                    phone: userData.phone || '',
                    company: userData.company || '',
                    address: userData.address || {}
                });
            }
            
            // Keep for backward compatibility, but discourage usage
            createGuestAccount(paymentData) {
                console.warn('Guest accounts are deprecated. Please use createRegisteredAccount instead.');
                return this.createAccount({
                    accountType: 'guest',
                    email: paymentData.payerEmail || 'guest@sirsinexus.com',
                    firstName: paymentData.firstName || 'Guest',
                    lastName: paymentData.lastName || 'User',
                    phone: paymentData.payerPhone || '',
                    company: paymentData.company || '',
                    address: paymentData.payerAddress || {}
                });
            }
            
            getOrCreateProject(projectIdentifier, invoiceData = null) {
                let project;
                
                if (projectIdentifier) {
                    // Try to get existing project
                    project = this.getProject(projectIdentifier);
                    if (project) return project;
                }
                
                // Create new project
                const projectId = this.generateProjectId();
                let projectName, projectDescription, projectCategory;
                
                if (invoiceData) {
                    projectName = `${invoiceData.service} - ${invoiceData.client}`;
                    projectDescription = `Project for ${invoiceData.service} service delivered to ${invoiceData.client}`;
                    projectCategory = this.categorizeService(invoiceData.service);
                } else if (projectIdentifier === 'general-services') {
                    projectName = 'General Services';
                    projectDescription = 'Miscellaneous payments and general services';
                    projectCategory = 'general';
                } else {
                    projectName = projectIdentifier || 'Unnamed Project';
                    projectDescription = `Project: ${projectName}`;
                    projectCategory = 'custom';
                }
                
                project = {
                    projectId: projectId,
                    projectName: projectName,
                    projectDescription: projectDescription,
                    projectCategory: projectCategory,
                    status: 'active',
                    metadata: {
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString(),
                        createdBy: currentUser ? currentUser.userId : 'system',
                        sessionId: this.sessionId
                    },
                    financial: {
                        totalRevenue: 0,
                        totalTransactions: 0,
                        currency: 'USD',
                        lastPaymentAt: null
                    },
                    clients: [],
                    transactions: [], // Transaction IDs associated with this project
                    invoices: [], // Invoice IDs associated with this project
                    milestones: [],
                    tags: []
                };
                
                // Store project
                this.storeProject(project);
                
                console.log('Project created:', projectId, projectName);
                return project;
            }
            
            categorizeService(serviceName) {
                const serviceCategories = {
                    'ai': ['artificial intelligence', 'machine learning', 'ai consulting', 'neural networks'],
                    'infrastructure': ['cloud setup', 'server management', 'devops', 'infrastructure'],
                    'consulting': ['consulting', 'advisory', 'strategy', 'planning'],
                    'development': ['development', 'programming', 'coding', 'software'],
                    'data': ['data analysis', 'analytics', 'big data', 'database'],
                    'security': ['cybersecurity', 'security audit', 'penetration testing', 'compliance'],
                    'training': ['training', 'education', 'workshop', 'course']
                };
                
                const service = serviceName.toLowerCase();
                for (const [category, keywords] of Object.entries(serviceCategories)) {
                    if (keywords.some(keyword => service.includes(keyword))) {
                        return category;
                    }
                }
                
                return 'other';
            }
            
            storeAccount(account) {
                // Store in localStorage for now (in production, send to server)
                const accounts = JSON.parse(localStorage.getItem('sirsi-accounts') || '{}');
                accounts[account.userId] = account;
                localStorage.setItem('sirsi-accounts', JSON.stringify(accounts));
                
                // Also store current user reference
                localStorage.setItem('sirsi-current-user', account.userId);
                
                // Update account index for faster lookups
                this.updateAccountIndex(account);
            }
            
            updateAccountIndex(account) {
                const index = JSON.parse(localStorage.getItem('sirsi-account-index') || '{}');
                
                // Index by email
                if (account.profile.email) {
                    index.byEmail = index.byEmail || {};
                    index.byEmail[account.profile.email.toLowerCase()] = account.userId;
                }
                
                // Index by account type
                index.byType = index.byType || {};
                index.byType[account.accountType] = index.byType[account.accountType] || [];
                if (!index.byType[account.accountType].includes(account.userId)) {
                    index.byType[account.accountType].push(account.userId);
                }
                
                // Index by creation date
                const dateKey = new Date(account.metadata.createdAt).toISOString().split('T')[0];
                index.byDate = index.byDate || {};
                index.byDate[dateKey] = index.byDate[dateKey] || [];
                if (!index.byDate[dateKey].includes(account.userId)) {
                    index.byDate[dateKey].push(account.userId);
                }
                
                localStorage.setItem('sirsi-account-index', JSON.stringify(index));
            }
            
            storeProject(project) {
                const projects = JSON.parse(localStorage.getItem('sirsi-projects') || '{}');
                projects[project.projectId] = project;
                localStorage.setItem('sirsi-projects', JSON.stringify(projects));
                
                // Update project index
                this.updateProjectIndex(project);
            }
            
            updateProjectIndex(project) {
                const index = JSON.parse(localStorage.getItem('sirsi-project-index') || '{}');
                
                // Index by category
                index.byCategory = index.byCategory || {};
                index.byCategory[project.projectCategory] = index.byCategory[project.projectCategory] || [];
                if (!index.byCategory[project.projectCategory].includes(project.projectId)) {
                    index.byCategory[project.projectCategory].push(project.projectId);
                }
                
                // Index by status
                index.byStatus = index.byStatus || {};
                index.byStatus[project.status] = index.byStatus[project.status] || [];
                if (!index.byStatus[project.status].includes(project.projectId)) {
                    index.byStatus[project.status].push(project.projectId);
                }
                
                localStorage.setItem('sirsi-project-index', JSON.stringify(index));
            }
            
            getAccount(userId) {
                const accounts = JSON.parse(localStorage.getItem('sirsi-accounts') || '{}');
                return accounts[userId] || null;
            }
            
            getAccountByEmail(email) {
                const index = JSON.parse(localStorage.getItem('sirsi-account-index') || '{}');
                const userId = index.byEmail?.[email.toLowerCase()];
                return userId ? this.getAccount(userId) : null;
            }
            
            getCurrentUser() {
                const currentUserId = localStorage.getItem('sirsi-current-user');
                return currentUserId ? this.getAccount(currentUserId) : null;
            }
            
            getProject(projectId) {
                const projects = JSON.parse(localStorage.getItem('sirsi-projects') || '{}');
                return projects[projectId] || null;
            }
            
            getProjectsByCategory(category) {
                const index = JSON.parse(localStorage.getItem('sirsi-project-index') || '{}');
                const projectIds = index.byCategory?.[category] || [];
                return projectIds.map(id => this.getProject(id)).filter(p => p);
            }
            
            recordTransaction(transactionData) {
                const transactionId = this.generateTransactionId();
                
                // Ensure we have a project context
                const projectContext = this.currentProject || this.getOrCreateProject('general-services');
                
                const transaction = {
                    transactionId: transactionId,
                    userId: currentUser ? currentUser.userId : null,
                    accountId: currentUser ? currentUser.accountId : null,
                    projectId: projectContext.projectId,
                    sessionId: this.sessionId,
                    type: transactionData.type || 'payment',
                    status: transactionData.status || 'pending',
                    amount: transactionData.amount,
                    currency: transactionData.currency || 'USD',
                    description: transactionData.description,
                    paymentMethod: transactionData.paymentMethod,
                    paymentProcessor: transactionData.paymentProcessor,
                    processorTransactionId: transactionData.processorTransactionId || null,
                    
                    // Enhanced categorization
                    category: {
                        primary: this.categorizeTransaction(transactionData),
                        secondary: transactionData.category || 'payment',
                        tags: transactionData.tags || []
                    },
                    
                    // PCI DSS compliant data storage
                    paymentDetails: {
                        maskedCardNumber: transactionData.maskedCardNumber || null,
                        cardBrand: transactionData.cardBrand || null,
                        last4: transactionData.last4 || null,
                        expiryMonth: null, // Never store
                        expiryYear: null,  // Never store
                        cvv: null,         // Never store
                        paymentMethodType: this.getPaymentMethodType(transactionData.paymentMethod),
                        processorDetails: {
                            processorName: transactionData.paymentProcessor,
                            processorVersion: transactionData.processorVersion || '1.0',
                            processingTime: null // Will be updated when completed
                        }
                    },
                    
                    payer: {
                        name: transactionData.payerName || '',
                        email: transactionData.payerEmail || '',
                        phone: transactionData.payerPhone || '',
                        address: transactionData.payerAddress || {},
                        identification: {
                            type: 'email', // Primary identification method
                            value: transactionData.payerEmail || '',
                            verified: false
                        }
                    },
                    
                    invoice: currentInvoice ? {
                        invoiceId: currentInvoice.number || this.generateInvoiceId(),
                        service: currentInvoice.service,
                        client: currentInvoice.client,
                        originalAmount: currentInvoice.amount,
                        dueDate: currentInvoice.dueDate || null,
                        issueDate: currentInvoice.date || new Date().toISOString()
                    } : null,
                    
                    project: {
                        projectId: projectContext.projectId,
                        projectName: projectContext.projectName,
                        projectCategory: projectContext.projectCategory
                    },
                    
                    fees: {
                        processingFee: currentFeeAmount || 0,
                        netAmount: (transactionData.amount - (currentFeeAmount || 0)),
                        feeStructure: transactionData.feeStructure || 'standard',
                        feeBreakdown: this.calculateDetailedFees(transactionData.amount, transactionData.paymentMethod)
                    },
                    
                    financial: {
                        exchangeRate: 1.0, // For future multi-currency support
                        baseCurrency: 'USD',
                        taxInfo: {
                            taxIncluded: false,
                            taxRate: 0,
                            taxAmount: 0,
                            taxJurisdiction: 'US'
                        }
                    },
                    
                    location: {
                        ipAddress: 'CLIENT_IP',
                        country: 'US', // Would be determined from IP
                        region: null,
                        city: null,
                        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
                    },
                    
                    metadata: {
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString(),
                        source: 'sirsi_payment_portal',
                        version: '2.0', // Enhanced version
                        deviceFingerprint: this.sessionData.deviceFingerprint,
                        clientInfo: {
                            userAgent: navigator.userAgent,
                            platform: navigator.platform,
                            language: navigator.language,
                            timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                            screenResolution: `${screen.width}x${screen.height}`,
                            colorDepth: screen.colorDepth
                        },
                        businessContext: {
                            channel: 'web_portal',
                            campaign: null, // Could be populated from UTM parameters
                            referralSource: document.referrer,
                            landingPage: window.location.href
                        }
                    },
                    
                    // Compliance and audit trail
                    compliance: {
                        pciDssCompliant: true,
                        dataRetentionPolicy: '7_years',
                        encryptionLevel: 'AES-256',
                        gdprCompliant: true,
                        auditTrail: [{
                            action: 'transaction_created',
                            timestamp: new Date().toISOString(),
                            userId: currentUser ? currentUser.userId : 'guest',
                            sessionId: this.sessionId,
                            details: {
                                paymentMethod: transactionData.paymentMethod,
                                amount: transactionData.amount,
                                projectId: projectContext.projectId
                            }
                        }],
                        riskAssessment: {
                            riskScore: this.calculateRiskScore(transactionData),
                            riskFactors: [],
                            approved: true
                        }
                    },
                    
                    // Integration tracking
                    integration: {
                        webhooksDelivered: [],
                        notificationsSent: [],
                        exportedTo: [],
                        syncedWith: []
                    }
                };
                
                // Store transaction
                this.storeTransaction(transaction);
                
                // Update user's transaction history
                if (currentUser) {
                    this.addTransactionToUser(currentUser.userId, transactionId);
                }
                
                // Update project's transaction history
                this.addTransactionToProject(projectContext.projectId, transactionId, transactionData.amount);
                
                // Update various indices and statistics
                this.updateTransactionIndices(transaction);
                
                console.log('Comprehensive transaction recorded:', {
                    transactionId: transactionId,
                    userId: transaction.userId,
                    accountId: transaction.accountId,
                    projectId: transaction.projectId,
                    paymentMethod: transaction.paymentMethod,
                    amount: transaction.amount
                });
                
                return transaction;
            }
            
            categorizeTransaction(transactionData) {
                const methodCategories = {
                    'paypal': 'digital_wallet',
                    'credit_card': 'card_payment',
                    'debit_card': 'card_payment',
                    'apple_pay': 'digital_wallet',
                    'google_pay': 'digital_wallet',
                    'zelle': 'bank_transfer',
                    'venmo': 'digital_wallet',
                    'bank_transfer': 'bank_transfer'
                };
                
                return methodCategories[transactionData.paymentMethod] || 'other';
            }
            
            getPaymentMethodType(paymentMethod) {
                const types = {
                    'paypal': 'digital_wallet',
                    'apple_pay': 'mobile_wallet',
                    'google_pay': 'mobile_wallet',
                    'zelle': 'instant_transfer',
                    'venmo': 'peer_to_peer',
                    'credit_card': 'card',
                    'debit_card': 'card'
                };
                
                return types[paymentMethod] || 'unknown';
            }
            
            calculateDetailedFees(amount, paymentMethod) {
                const feeStructures = {
                    'paypal': { rate: 0.0349, fixed: 0.49, name: 'PayPal Standard' },
                    'zelle': { rate: 0, fixed: 0, name: 'Zelle (No Fees)' },
                    'apple_pay': { rate: 0.0299, fixed: 0.10, name: 'Apple Pay' },
                    'google_pay': { rate: 0.0299, fixed: 0.10, name: 'Google Pay' },
                    'venmo': { rate: 0.0349, fixed: 0.49, name: 'Venmo' }
                };
                
                const structure = feeStructures[paymentMethod] || { rate: 0.035, fixed: 0.49, name: 'Standard' };
                const percentageFee = amount * structure.rate;
                const totalFee = percentageFee + structure.fixed;
                
                return {
                    structure: structure.name,
                    percentageRate: structure.rate,
                    percentageFee: Math.round(percentageFee * 100) / 100,
                    fixedFee: structure.fixed,
                    totalFee: Math.round(totalFee * 100) / 100,
                    netAmount: Math.round((amount - totalFee) * 100) / 100
                };
            }
            
            calculateRiskScore(transactionData) {
                let score = 0;
                
                // Amount-based risk
                if (transactionData.amount > 1000) score += 20;
                else if (transactionData.amount > 500) score += 10;
                else if (transactionData.amount > 100) score += 5;
                
                // Payment method risk
                const methodRisk = {
                    'zelle': 5,
                    'paypal': 10,
                    'apple_pay': 5,
                    'google_pay': 5,
                    'credit_card': 15,
                    'venmo': 10
                };
                
                score += methodRisk[transactionData.paymentMethod] || 20;
                
                // New user risk
                if (!currentUser || currentUser.accountType === 'guest') {
                    score += 15;
                }
                
                return Math.min(score, 100); // Cap at 100
            }
            
            addTransactionToProject(projectId, transactionId, amount) {
                const project = this.getProject(projectId);
                if (project) {
                    project.transactions.push(transactionId);
                    project.financial.totalRevenue += amount;
                    project.financial.totalTransactions += 1;
                    project.financial.lastPaymentAt = new Date().toISOString();
                    project.metadata.updatedAt = new Date().toISOString();
                    
                    this.storeProject(project);
                }
            }
            
            storeTransaction(transaction) {
                // Store in localStorage for now (in production, send to secure server)
                const transactions = JSON.parse(localStorage.getItem('sirsi-transactions') || '{}');
                transactions[transaction.transactionId] = transaction;
                localStorage.setItem('sirsi-transactions', JSON.stringify(transactions));
                
                // Update transaction statistics
                this.updateTransactionStatistics(transaction);
            }
            
            updateTransactionIndices(transaction) {
                const index = JSON.parse(localStorage.getItem('sirsi-transaction-index') || '{}');
                
                // Index by payment method
                index.byPaymentMethod = index.byPaymentMethod || {};
                index.byPaymentMethod[transaction.paymentMethod] = index.byPaymentMethod[transaction.paymentMethod] || [];
                index.byPaymentMethod[transaction.paymentMethod].push(transaction.transactionId);
                
                // Index by project
                index.byProject = index.byProject || {};
                index.byProject[transaction.projectId] = index.byProject[transaction.projectId] || [];
                index.byProject[transaction.projectId].push(transaction.transactionId);
                
                // Index by date
                const dateKey = new Date(transaction.metadata.createdAt).toISOString().split('T')[0];
                index.byDate = index.byDate || {};
                index.byDate[dateKey] = index.byDate[dateKey] || [];
                index.byDate[dateKey].push(transaction.transactionId);
                
                // Index by status
                index.byStatus = index.byStatus || {};
                index.byStatus[transaction.status] = index.byStatus[transaction.status] || [];
                index.byStatus[transaction.status].push(transaction.transactionId);
                
                // Index by amount range
                const amountRange = this.getAmountRange(transaction.amount);
                index.byAmountRange = index.byAmountRange || {};
                index.byAmountRange[amountRange] = index.byAmountRange[amountRange] || [];
                index.byAmountRange[amountRange].push(transaction.transactionId);
                
                localStorage.setItem('sirsi-transaction-index', JSON.stringify(index));
            }
            
            getAmountRange(amount) {
                if (amount < 10) return '0-10';
                if (amount < 50) return '10-50';
                if (amount < 100) return '50-100';
                if (amount < 500) return '100-500';
                if (amount < 1000) return '500-1000';
                if (amount < 5000) return '1000-5000';
                return '5000+';
            }
            
            updateTransactionStatistics(transaction) {
                const stats = JSON.parse(localStorage.getItem('sirsi-transaction-stats') || '{}');
                const today = new Date().toISOString().split('T')[0];
                
                // Daily stats
                stats.daily = stats.daily || {};
                stats.daily[today] = stats.daily[today] || {
                    count: 0,
                    totalAmount: 0,
                    byPaymentMethod: {},
                    byProject: {}
                };
                
                stats.daily[today].count += 1;
                stats.daily[today].totalAmount += transaction.amount;
                
                // By payment method
                stats.daily[today].byPaymentMethod[transaction.paymentMethod] = 
                    (stats.daily[today].byPaymentMethod[transaction.paymentMethod] || 0) + transaction.amount;
                
                // By project
                stats.daily[today].byProject[transaction.projectId] = 
                    (stats.daily[today].byProject[transaction.projectId] || 0) + transaction.amount;
                
                // Overall stats
                stats.overall = stats.overall || {
                    totalTransactions: 0,
                    totalRevenue: 0,
                    averageTransactionValue: 0,
                    topPaymentMethods: {},
                    topProjects: {}
                };
                
                stats.overall.totalTransactions += 1;
                stats.overall.totalRevenue += transaction.amount;
                stats.overall.averageTransactionValue = stats.overall.totalRevenue / stats.overall.totalTransactions;
                
                // Track payment method usage
                stats.overall.topPaymentMethods[transaction.paymentMethod] = 
                    (stats.overall.topPaymentMethods[transaction.paymentMethod] || 0) + 1;
                
                // Track project revenue
                stats.overall.topProjects[transaction.projectId] = 
                    (stats.overall.topProjects[transaction.projectId] || 0) + transaction.amount;
                
                localStorage.setItem('sirsi-transaction-stats', JSON.stringify(stats));
            }
            
            addTransactionToUser(userId, transactionId) {
                const user = this.getAccount(userId);
                if (user) {
                    if (!user.transactionHistory) {
                        user.transactionHistory = [];
                    }
                    user.transactionHistory.push(transactionId);
                    this.storeAccount(user);
                }
            }
            
            getTransaction(transactionId) {
                const transactions = JSON.parse(localStorage.getItem('sirsi-transactions') || '{}');
                return transactions[transactionId] || null;
            }
            
            getUserTransactions(userId) {
                const user = this.getAccount(userId);
                if (!user || !user.transactionHistory) return [];
                
                const transactions = JSON.parse(localStorage.getItem('sirsi-transactions') || '{}');
                return user.transactionHistory.map(txnId => transactions[txnId]).filter(txn => txn);
            }
            
            updateTransactionStatus(transactionId, status, additionalData = {}) {
                const transaction = this.getTransaction(transactionId);
                if (transaction) {
                    transaction.status = status;
                    transaction.metadata.updatedAt = new Date().toISOString();
                    
                    // Add to audit trail
                    transaction.compliance.auditTrail.push({
                        action: `status_changed_to_${status}`,
                        timestamp: new Date().toISOString(),
                        userId: currentUser ? currentUser.userId : 'system',
                        sessionId: this.sessionId,
                        additionalData: additionalData
                    });
                    
                    // Merge additional data
                    Object.assign(transaction, additionalData);
                    
                    this.storeTransaction(transaction);
                    console.log('Transaction status updated:', transactionId, status);
                }
            }
            
            // Refund capability
            initiateRefund(transactionId, refundAmount, reason = 'customer_request') {
                const originalTransaction = this.getTransaction(transactionId);
                if (!originalTransaction) {
                    console.error('Transaction not found for refund:', transactionId);
                    return null;
                }
                
                const refundTransaction = {
                    ...originalTransaction,
                    transactionId: this.generateTransactionId(),
                    type: 'refund',
                    status: 'pending',
                    amount: -Math.abs(refundAmount), // Negative amount for refund
                    originalTransactionId: transactionId,
                    refundReason: reason,
                    metadata: {
                        ...originalTransaction.metadata,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString(),
                        refundInitiatedBy: currentUser ? currentUser.userId : 'admin'
                    }
                };
                
                this.storeTransaction(refundTransaction);
                
                // Update original transaction
                this.updateTransactionStatus(transactionId, 'refunded', {
                    refundTransactionId: refundTransaction.transactionId,
                    refundAmount: refundAmount,
                    refundReason: reason
                });
                
                console.log('Refund initiated:', refundTransaction.transactionId);
                return refundTransaction;
            }
        }
        
        // Initialize account manager
        const accountManager = new SirsiAccountManager();
        
        // Ensure parent overflow doesn't hide content, but do not force-show sections
        window.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                const mainSection = document.querySelector('section');
                if (mainSection) {
                    mainSection.style.overflow = 'visible';
                }
            }, 100);
        });

        // Streamlined Registration & Account System
        function initializeRegistration() {
            const registrationForm = document.getElementById('registration-form');
            const emailInput = document.getElementById('reg-email');

            const existingUser = accountManager.getCurrentUser();
            if (existingUser && existingUser.accountType === 'registered') {
                currentUser = existingUser;
                registrationRequired = false;
                console.log('Existing registered user found:', currentUser.userId);
                showRegisteredState(currentUser);
            } else {
                console.log('No registered user found. Displaying registration form.');
                showRegistrationForm();
            }
            
            if (registrationForm) {
                registrationForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const formData = {
                        email: document.getElementById('reg-email').value.trim(),
                        firstName: document.getElementById('reg-first-name').value.trim(),
                        lastName: document.getElementById('reg-last-name').value.trim(),
                        phone: '' // Phone field removed for streamlining
                    };
                    
                    if (!document.getElementById('reg-terms').checked) {
                        showRegistrationError('You must agree to the Terms of Service and Privacy Policy.');
                        return;
                    }
                    
                    if (!formData.email || !formData.firstName) {
                        showRegistrationError('Please fill in all required fields.');
                        return;
                    }
                    
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(formData.email)) {
                        showRegistrationError('Please enter a valid email address.');
                        return;
                    }
                    
                    try {
                        const newUser = accountManager.createRegisteredAccount(formData);
                        currentUser = newUser;
                        registrationRequired = false;
                        console.log('User successfully registered:', currentUser.userId);
                        
                        showRegisteredState(newUser);
                        updateAllPaymentButtons();
                        showInlineMessage('Account created successfully! You can now proceed with your payment.', 'success');
                    } catch (error) {
                        console.error('Registration failed:', error);
                        showRegistrationError(error.message);
                    }
                });
            }
            
            if(emailInput) {
                emailInput.addEventListener('blur', function() {
                    const email = emailInput.value.trim();
                    if (email) {
                        const existingAccount = accountManager.getAccountByEmail(email);
                        if (existingAccount && existingAccount.accountType === 'registered') {
                            currentUser = existingAccount;
                            registrationRequired = false;
                            showRegisteredState(existingAccount);
                            updateAllPaymentButtons();
                            showInlineMessage('Welcome back! Your information has been pre-filled.', 'info');
                        }
                    }
                });
            }
        }

        function showRegisteredState(user) {
            const regSection = document.getElementById('registration-section');
            if (!regSection) return;

            // Keep both form and welcome message visible
            // document.getElementById('registration-form').classList.add('hidden');
            
            const welcomeDiv = document.getElementById('welcome-back-message');
            // welcomeDiv.classList.remove('hidden');
            document.getElementById('welcome-back-name').textContent = user.profile.firstName;

            // Still populate form fields in the background for data consistency
            document.getElementById('reg-email').value = user.profile.email;
            document.getElementById('reg-first-name').value = user.profile.firstName;
            document.getElementById('reg-last-name').value = user.profile.lastName;
        }

        function showRegistrationForm() {
            const regSection = document.getElementById('registration-section');
            if (!regSection) return;

            // Keep both visible
            // document.getElementById('registration-form').classList.remove('hidden');
            // document.getElementById('welcome-back-message').classList.add('hidden');
        }

        function skipRegistration() {
            console.log('Creating guest account...');
            try {
                currentUser = accountManager.createGuestAccount({
                    payerEmail: 'guest-' + Date.now() + '@payment.local',
                    firstName: 'Guest',
                    lastName: 'User'
                });
                
                registrationRequired = false;
                console.log('Guest account created:', currentUser.userId);
                
                // Keep registration form visible
                const registrationForm = document.getElementById('registration-form');
                if (registrationForm) {
                    // registrationForm.classList.add('hidden');
                }
                
                // Show welcome message for guest
                const welcomeMessage = document.getElementById('welcome-back-message');
                const welcomeName = document.getElementById('welcome-back-name');
                if (welcomeMessage && welcomeName) {
                    welcomeName.textContent = 'Guest';
                    // welcomeMessage.classList.remove('hidden');
                }
                
                updateAllPaymentButtons();
                showInlineMessage('Continuing as guest. You can register on your next visit to track payments.', 'info');
                
                // Scroll to payment section
                const paymentCard = document.getElementById('custom-payment-card');
                if (paymentCard) {
                    setTimeout(() => {
                        paymentCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 500);
                }
            } catch (error) {
                console.error('Failed to create guest account:', error);
                showInlineMessage('Failed to create guest account. Please try again.', 'error');
            }
        }

        function logoutAndReload() {
            localStorage.removeItem('sirsi-current-user');
            window.location.reload();
        }

        function showRegistrationError(message) {
            const existingError = document.getElementById('registration-error');
            if (existingError) {
                existingError.remove();
            }
            
            const errorDiv = document.createElement('div');
            errorDiv.id = 'registration-error';
            errorDiv.className = 'mt-4 p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg';
            errorDiv.innerHTML = `
                <div class="flex items-start gap-2">
                    <svg class="w-4 h-4 text-red-600 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                    <span class="text-red-600 dark:text-red-400 text-sm font-medium">${message}</span>
                </div>
            `;
            
            const formActions = document.getElementById('registration-form-actions');
            if (formActions) {
                formActions.parentNode.insertBefore(errorDiv, formActions);
            }
        }
        
        // Google Pay configuration
        const googlePayConfig = {
            environment: 'TEST', // Change to 'PRODUCTION' for live
            apiVersion: 2,
            apiVersionMinor: 0,
            allowedPaymentMethods: [{
                type: 'CARD',
                parameters: {
                    allowedAuthMethods: ['PAN_ONLY', 'CRYPTOGRAM_3DS'],
                    allowedCardNetworks: ['AMEX', 'DISCOVER', 'JCB', 'MASTERCARD', 'VISA']
                },
                tokenizationSpecification: {
                    type: 'PAYMENT_GATEWAY',
                    parameters: {
                        'gateway': 'example',
                        'gatewayMerchantId': 'exampleGatewayMerchantId'
                    }
                }
            }]
        };
        
        // Google Pay callback
        function onGooglePayLoaded() {
            console.log('Google Pay SDK loaded');
            if (typeof google !== 'undefined' && google.payments) {
                googlePayClient = new google.payments.api.PaymentsClient(googlePayConfig);
                checkGooglePayAvailability();
            }
        }
        
        function checkGooglePayAvailability() {
            if (!googlePayClient) return;
            
            googlePayClient.isReadyToPay({
                apiVersion: googlePayConfig.apiVersion,
                apiVersionMinor: googlePayConfig.apiVersionMinor,
                allowedPaymentMethods: googlePayConfig.allowedPaymentMethods
            }).then(function(response) {
                if (response.result) {
                    console.log('Google Pay is available');
                    // Will show button when amount is entered
                }
            }).catch(function(err) {
                console.log('Google Pay not available:', err);
            });
        }
        
        function checkApplePayAvailability() {
            // Direct Apple Pay (Safari/iOS)
            if (window.ApplePaySession && ApplePaySession.canMakePayments()) {
                console.log('Direct Apple Pay is available');
                return { type: 'direct', available: true };
            }
            
            // iOS 18+ QR Code Apple Pay (any browser)
            // Check if we can detect potential Apple Pay support via user agent or other signals
            const userAgent = navigator.userAgent.toLowerCase();
            const isIOS = /iphone|ipad|ipod/.test(userAgent);
            const isMac = /macintosh|mac os x/.test(userAgent);
            const hasAppleDevice = isIOS || isMac;
            
            // For non-Safari browsers, offer QR code method if on Apple ecosystem
            if (hasAppleDevice || true) { // Enable for all devices to allow QR scanning
                console.log('QR Code Apple Pay may be available');
                return { type: 'qr', available: true };
            }
            
            return { type: 'none', available: false };
        }
        
        // PayPal SDK loaded callback
        function onPayPalLoaded() {
            console.log('PayPal SDK fully loaded and ready');
            initializePaymentSystem();
        }
        
        // Wait for both DOM and PayPal SDK to be fully loaded
        function initializePaymentSystem() {
            console.log('Initializing payment page...');
            
            // Initialize theme toggle
            initializeThemeToggle();
            
            // Initialize admin status
            checkAdminStatus();
            
            // Initialize registration system
            initializeRegistration();
            
            // Initialize PayPal payment system
            const urlParams = new URLSearchParams(window.location.search);
            const invoiceData = urlParams.get('invoice');
            
            if (invoiceData) {
                try {
                    currentInvoice = JSON.parse(decodeURIComponent(invoiceData));
                    setupInvoicePayment();
                } catch (e) {
                    console.error('Invalid invoice data:', e);
                    currentInvoice = null;
                }
            }
            
            // Setup payment sections based on context
            setupAllPaymentSections();
            updateAllPaymentButtons();
            
            // Debug: log current state
            console.log('Payment system initialized. Invoice present:', !!currentInvoice);
        }
        
        function setupInvoicePayment() {
            if (!currentInvoice) return;
            
            // Show invoice section and hide custom payment section
            document.getElementById('invoice-section').style.display = 'block';
            document.getElementById('custom-payment-section').style.display = 'none';
            
            // Populate invoice details
            const invoiceAmount = parseFloat(currentInvoice.amount);
            document.getElementById('invoice-number').textContent = currentInvoice.number;
            document.getElementById('invoice-service').textContent = currentInvoice.service;
            document.getElementById('invoice-client').textContent = currentInvoice.client;
            document.getElementById('invoice-date').textContent = new Date(currentInvoice.date).toLocaleDateString();
            document.getElementById('invoice-amount').textContent = '$' + invoiceAmount.toFixed(2);
            document.getElementById('invoice-minimum').textContent = '$' + invoiceAmount.toFixed(2);
            
            // Set up editable payment amount with minimum validation
            const paymentAmountInput = document.getElementById('invoice-payment-amount');
            const paymentDescInput = document.getElementById('invoice-payment-description');
            
            if (paymentAmountInput) {
                paymentAmountInput.value = invoiceAmount.toFixed(2);
                paymentAmountInput.min = invoiceAmount;
                
                // Add real-time validation and button updates
                paymentAmountInput.addEventListener('input', function() {
                    validateInvoicePayment();
                    updateInvoicePaymentButtons();
                });
            }
            
            if (paymentDescInput) {
                paymentDescInput.value = `Invoice ${currentInvoice.number} - ${currentInvoice.service}`;
                paymentDescInput.addEventListener('input', updateInvoicePaymentButtons);
            }
        }
        
        function setupAllPaymentSections() {
            // Show the appropriate payment section based on invoice availability
            if (!currentInvoice) {
                // Show custom payment section, hide invoice section
                const customSection = document.getElementById('custom-payment-section');
                const invoiceSection = document.getElementById('invoice-section');
                
                if (customSection) {
                    customSection.style.display = 'block';
                }
                if (invoiceSection) {
                    invoiceSection.style.display = 'none';
                }
                
                // Add event listeners for real-time updates on custom payment
                const amountInput = document.getElementById('payment-amount');
                const descInput = document.getElementById('payment-description');
                
                if (amountInput) {
                    amountInput.addEventListener('input', updatePayPalButtons);
                }
                if (descInput) {
                    descInput.addEventListener('input', updatePayPalButtons);
                }
            }
        }
        
        function updateAllPaymentButtons() {
            // Update appropriate section based on current context
            if (currentInvoice) {
                updateInvoicePaymentButtons();
            } else {
                updatePayPalButtons();
            }
        }
        
        // Smart initialization with multiple triggers
        let paymentSystemInitialized = false;
        
        function safeInitializePaymentSystem() {
            if (paymentSystemInitialized) return;
            paymentSystemInitialized = true;
            
            console.log('Safe payment system initialization');
            initializePaymentSystem();
        }
        
        // Wait for DOM to be ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', safeInitializePaymentSystem);
        } else {
            safeInitializePaymentSystem();
        }
        
        // Backup initialization on window load
        window.addEventListener('load', function() {
            setTimeout(safeInitializePaymentSystem, 100);
        });
        
        function initializeThemeToggle() {
            const themeToggle = document.getElementById('theme-toggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    const html = document.documentElement;
                    const isDark = html.classList.contains('dark');
                    
                    if (isDark) {
                        html.classList.remove('dark');
                        localStorage.setItem('theme', 'light');
                    } else {
                        html.classList.add('dark');
                        localStorage.setItem('theme', 'dark');
                    }
                });
            }
        }
        
        // Removed showInvoicePayment and showCustomPayment functions that were hiding elements
        
        function validateInvoicePayment() {
            if (!currentInvoice) return true;
            
            const paymentAmountInput = document.getElementById('invoice-payment-amount');
            const invoiceAmount = parseFloat(currentInvoice.amount);
            const paymentAmount = parseFloat(paymentAmountInput.value) || 0;
            
            if (paymentAmount < invoiceAmount) {
                // Add error styling
                paymentAmountInput.classList.add('border-red-500', 'ring-2', 'ring-red-200');
                
                // Show error message
                showInvoiceAmountError(`Payment amount must be at least $${invoiceAmount.toFixed(2)}`);
                return false;
            } else {
                // Remove error styling
                paymentAmountInput.classList.remove('border-red-500', 'ring-2', 'ring-red-200');
                clearInvoiceAmountError();
                return true;
            }
        }
        
        function updateInvoicePaymentButtons() {
            if (!currentInvoice) return;
            
            const paymentAmountInput = document.getElementById('invoice-payment-amount');
            const paymentDescInput = document.getElementById('invoice-payment-description');
            
            const amount = parseFloat(paymentAmountInput.value) || 0;
            let description = paymentDescInput.value || `Invoice ${currentInvoice.number} - ${currentInvoice.service}`;
            
            // Add overpayment note if paying more than invoice
            const invoiceAmount = parseFloat(currentInvoice.amount);
            if (amount > invoiceAmount) {
                const overpayment = amount - invoiceAmount;
                description += ` (includes $${overpayment.toFixed(2)} overpayment)`;
            }
            
            // Calculate fees and update display
            if (amount > 0) {
                calculateAndDisplayFees(amount, 'invoice');
            } else {
                hideFeeBreakdown('invoice');
            }
            
            updatePayPalState(currentTotalAmount, description);
        }
        
        let _ppUpdateTimer = null;
        function updatePayPalButtons() {
            // Debounce rapid input changes to avoid re-render thrash
            clearTimeout(_ppUpdateTimer);
            _ppUpdateTimer = setTimeout(() => {
                const amountInput = document.getElementById('payment-amount');
                const descInput = document.getElementById('payment-description');
                
                const amount = amountInput ? parseFloat(amountInput.value) || 0 : 0;
                const description = descInput ? descInput.value || 'Payment to SirsiNexus' : 'Payment to SirsiNexus';
                
                // Calculate fees and update display
                if (amount > 0) {
                    calculateAndDisplayFees(amount, 'custom');
                } else {
                    hideFeeBreakdown('custom');
                }
                
                updatePayPalState(currentTotalAmount, description);
            }, 250);
        }
        
        let _lastPPRender = { amount: null, description: null };
        function updatePayPalState(amount, description) {
            _lastPPRender = { amount, description };
        }
        function openPayPalModal() {
            // Validate amount
            const amtInput = document.getElementById('payment-amount');
            const descInput = document.getElementById('payment-description');
            let amount = 0;
            let description = 'Payment to SirsiNexus';
            if (currentInvoice) {
                const paymentAmountInput = document.getElementById('invoice-payment-amount');
                const paymentDescInput = document.getElementById('invoice-payment-description');
                amount = parseFloat(paymentAmountInput?.value) || parseFloat(currentInvoice.amount) || 0;
                description = paymentDescInput?.value || `Invoice ${currentInvoice.number} - ${currentInvoice.service}`;
            } else {
                amount = parseFloat(amtInput?.value) || 0;
                description = descInput?.value || 'Payment to SirsiNexus';
            }
            if (amount < 1) { highlightAmountField(); return; }
            // Ensure fees/total are up to date
            if (currentInvoice) { calculateAndDisplayFees(amount, 'invoice'); } else { calculateAndDisplayFees(amount, 'custom'); }
            updatePayPalState(currentTotalAmount, description);
            const modal = document.getElementById('paypal-modal');
            if (modal) { modal.classList.remove('hidden'); modal.classList.add('flex'); }
            renderPayPalButtons(_lastPPRender.amount, _lastPPRender.description, '#paypal-sdk-buttons');
        }
        function closePayPalModal() {
            const modal = document.getElementById('paypal-modal');
            if (modal) { modal.classList.add('hidden'); modal.classList.remove('flex'); }
        }
        function renderPayPalButtons(amount, description, targetSelector = '#paypal-sdk-buttons') {
            // Render PayPal buttons into a dedicated container (modal)
            const container = document.querySelector(targetSelector);
            // Skip rerender if nothing changed and buttons already exist
            if (container && container.children && container.children.length > 0 && _lastPPRender.amount === amount && _lastPPRender.description === description) {
                return;
            }
            _lastPPRender = { amount, description };
            const messageDiv = document.getElementById('paypal-modal-message');
            
            if (!container) {
                console.error('PayPal container not found');
                return;
            }
            
            // Clear container and messages
            container.innerHTML = '';
            if (messageDiv) messageDiv.innerHTML = '';
            
            // Store current payment info
            currentAmount = amount || 0;
            currentDescription = description || 'Payment to SirsiNexus';
            
            // Always show buttons, but make them functional based on amount
            showApplePayButton(true);
            showGooglePayButton(true);
            
            // Check if PayPal SDK is loaded with retry mechanism
            if (typeof paypal === 'undefined') {
                console.warn('PayPal SDK not loaded, showing loading state');
                container.innerHTML = `
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white py-4 px-6 rounded-xl text-center">
                        <div class="flex items-center justify-center gap-3">
                            <div class="animate-spin rounded-full h-5 w-5 border-2 border-white border-t-transparent"></div>
                            <span class="font-medium">Loading PayPal...</span>
                        </div>
                    </div>
                `;
                
                // Retry PayPal loading
                setTimeout(() => {
                    if (typeof paypal !== 'undefined') {
                        renderPayPalButtons(amount, description);
                    } else {
                        container.innerHTML = `
                            <div class="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-xl p-4 text-center">
                                <p class="text-amber-700 dark:text-amber-300 font-medium mb-2">PayPal Loading Issue</p>
                                <p class="text-amber-600 dark:text-amber-400 text-sm mb-3">PayPal is taking longer than expected to load.</p>
                                <button onclick="location.reload()" class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                    Refresh Page
                                </button>
                            </div>
                        `;
                    }
                }, 3000);
                return;
            }
            
            // Check if paypal.Buttons is available
            if (typeof paypal.Buttons !== 'function') {
                console.error('PayPal Buttons not available');
                container.innerHTML = `
                    <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl p-4 text-center">
                        <p class="text-red-600 dark:text-red-400 font-medium mb-2">PayPal Service Unavailable</p>
                        <p class="text-red-500 dark:text-red-400 text-sm mb-3">PayPal payment buttons are temporarily unavailable.</p>
                        <button onclick="location.reload()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                            Try Again
                        </button>
                    </div>
                `;
                return;
            }
            
            console.log('Rendering PayPal buttons for amount:', amount, 'description:', description);
            
            try {
                paypal.Buttons({
                    createOrder: function(data, actions) {
                        let currentAmount, description;
                        
                        // Check if we're in invoice mode or custom payment mode
                        if (currentInvoice) {
                            // Invoice payment mode
                            const paymentAmountInput = document.getElementById('invoice-payment-amount');
                            const paymentDescInput = document.getElementById('invoice-payment-description');
                            
                            currentAmount = parseFloat(paymentAmountInput.value) || 0;
                            description = paymentDescInput.value || `Invoice ${currentInvoice.number} - ${currentInvoice.service}`;
                            
                            // Validate minimum amount for invoice
                            const invoiceAmount = parseFloat(currentInvoice.amount);
                            if (currentAmount < invoiceAmount) {
                                highlightInvoiceAmountField();
                                throw new Error(`Payment amount must be at least $${invoiceAmount.toFixed(2)}`);
                            }
                        } else {
                            // Custom payment mode
                            currentAmount = parseFloat(document.getElementById('payment-amount').value) || 0;
                            description = document.getElementById('payment-description').value || 'Payment to SirsiNexus';
                            
                            if (currentAmount < 1) {
                                highlightAmountField();
                                throw new Error('Amount must be $1 or more');
                            }
                        }
                        
                        console.log('Creating PayPal order for:', currentAmount);
                        return actions.order.create({
                            purchase_units: [{
                                amount: {
                                    value: currentAmount.toFixed(2),
                                    currency_code: 'USD'
                                },
                                description: description
                            }]
                        });
                    },
                    onApprove: function(data, actions) {
                        console.log('PayPal payment approved, capturing...');
                        return actions.order.capture().then(function(details) {
                            console.log('Payment successful:', details);
                            
                            // Record transaction with appropriate data based on payment mode
                            let amount, description;
                            if (currentInvoice) {
                                // Invoice payment
                                amount = parseFloat(document.getElementById('invoice-payment-amount').value);
                                description = document.getElementById('invoice-payment-description').value || `Invoice ${currentInvoice.number} - ${currentInvoice.service}`;
                            } else {
                                // Custom payment
                                amount = parseFloat(document.getElementById('payment-amount').value);
                                description = document.getElementById('payment-description').value || 'Payment to SirsiNexus';
                            }
                            
                            // Ensure we have a user account (should be created during registration)
                            if (!currentUser) {
                                console.error('No user account found during payment processing');
                                // Fallback: create account with PayPal data
                                currentUser = accountManager.createRegisteredAccount({
                                    email: details.payer.email_address,
                                    firstName: details.payer.name?.given_name || 'PayPal',
                                    lastName: details.payer.name?.surname || 'User'
                                });
                            }
                            
                            // Record comprehensive transaction in SirsiNexus system
                            const sirsiTransaction = accountManager.recordTransaction({
                                type: 'payment',
                                status: 'completed',
                                amount: amount,
                                description: description,
                                paymentMethod: 'paypal',
                                paymentProcessor: 'paypal',
                                processorTransactionId: details.id,
                                payerName: details.payer.name ? `${details.payer.name.given_name} ${details.payer.name.surname}` : 'PayPal User',
                                payerEmail: details.payer.email_address,
                                payerPhone: details.payer.phone?.phone_number?.national_number || '',
                                payerAddress: details.payer.address || {},
                                feeStructure: 'paypal_standard'
                            });
                            
                            // Legacy transaction storage for backward compatibility
                            const legacyTransaction = {
                                id: details.id,
                                payer: details.payer,
                                amount: amount,
                                description: description,
                                timestamp: new Date().toISOString(),
                                invoiceData: currentInvoice || null,
                                sirsiTransactionId: sirsiTransaction.transactionId,
                                userId: currentUser.userId
                            };
                            
                            localStorage.setItem('last-transaction', JSON.stringify(legacyTransaction));
                            
                            console.log('SirsiNexus transaction recorded:', sirsiTransaction.transactionId);
                            console.log('User account:', currentUser.userId);
                            
                            // Show success
                            showSuccessMessage(details);
                        });
                    },
                    onError: function(err) {
                        console.error('PayPal error:', err);
                        messageDiv.innerHTML = '<p class="text-red-500 text-sm">Payment failed. Please try again.</p>';
                    },
                    onCancel: function(data) {
                        console.log('Payment cancelled:', data);
                        messageDiv.innerHTML = '<p class="text-amber-600 text-sm">Payment was cancelled.</p>';
                    },
                    style: {
                        layout: 'vertical',
                        color: 'blue',
                        shape: 'rect',
                        label: 'paypal',
                        height: 55,
                        tagline: false
                    }
                }).render('#paypal-button-container').then(function() {
                    console.log('PayPal buttons rendered successfully');
                }).catch(function(err) {
                    console.error('PayPal render error:', err);
                    container.innerHTML = '<div class="bg-red-50 dark:bg-red-900/20 rounded-xl p-4 text-center"><p class="text-red-600 text-sm">Error loading PayPal. Please refresh.</p></div>';
                });
            } catch (error) {
                console.error('PayPal initialization error:', error);
                container.innerHTML = '<div class="bg-red-50 dark:bg-red-900/20 rounded-xl p-4 text-center"><p class="text-red-600 text-sm">PayPal system error.</p></div>';
            }
        }
        
        function highlightAmountField() {
            const amountField = document.getElementById('payment-amount');
            if (amountField) {
                // Add error styling
                amountField.classList.add('border-red-500', 'ring-2', 'ring-red-200');
                amountField.focus();
                
                // Show error message directly in the amount field area
                showAmountFieldError('Please enter an amount of $1.00 or more');
                
                // Remove error styling after user starts typing
                amountField.addEventListener('input', function removeErrorStyling() {
                    amountField.classList.remove('border-red-500', 'ring-2', 'ring-red-200');
                    clearAmountFieldError();
                    amountField.removeEventListener('input', removeErrorStyling);
                }, { once: true });
            }
        }
        
        function showAmountFieldError(message) {
            // Remove any existing error message
            clearAmountFieldError();
            
            // Create error message element
            const errorDiv = document.createElement('div');
            errorDiv.id = 'amount-field-error';
            errorDiv.className = 'mt-1 text-red-600 text-sm font-medium flex items-center gap-2';
            errorDiv.innerHTML = `
                <svg class="w-4 h-4 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                </svg>
                <span>${message}</span>
            `;
            
            // Insert after the amount input field
            const amountField = document.getElementById('payment-amount');
            if (amountField && amountField.parentNode) {
                amountField.parentNode.insertBefore(errorDiv, amountField.nextSibling);
            }
        }
        
        function clearAmountFieldError() {
            const errorDiv = document.getElementById('amount-field-error');
            if (errorDiv) {
                errorDiv.remove();
            }
        }
        
        function highlightInvoiceAmountField() {
            const amountField = document.getElementById('invoice-payment-amount');
            if (amountField) {
                // Add error styling
                amountField.classList.add('border-red-500', 'ring-2', 'ring-red-200');
                amountField.focus();
                
                // Trigger validation to show error message
                validateInvoicePayment();
            }
        }
        
        function showInvoiceAmountError(message) {
            // Remove any existing error message
            clearInvoiceAmountError();
            
            // Create error message element
            const errorDiv = document.createElement('div');
            errorDiv.id = 'invoice-amount-error';
            errorDiv.className = 'mt-1 text-red-600 text-sm font-medium flex items-center gap-2';
            errorDiv.innerHTML = `
                <svg class="w-4 h-4 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                </svg>
                <span>${message}</span>
            `;
            
            // Insert after the invoice payment amount input field
            const amountField = document.getElementById('invoice-payment-amount');
            if (amountField && amountField.parentNode) {
                amountField.parentNode.insertBefore(errorDiv, amountField.nextSibling);
            }
        }
        
        function clearInvoiceAmountError() {
            const errorDiv = document.getElementById('invoice-amount-error');
            if (errorDiv) {
                errorDiv.remove();
            }
        }
        
        function showInlineMessage(message, type = 'info') {
            const messageDiv = document.getElementById('payment-message');
            if (messageDiv) {
                const colorClass = type === 'error' ? 'text-red-600' : type === 'success' ? 'text-green-600' : 'text-blue-600';
                messageDiv.innerHTML = `<p class="${colorClass} text-sm font-medium flex items-center justify-center gap-2">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="${type === 'error' ? 'M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z' : 'M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z'}" clip-rule="evenodd"></path>
                    </svg>
                    ${message}
                </p>`;
                
                // Auto-clear after 5 seconds
                setTimeout(() => {
                    if (messageDiv) messageDiv.innerHTML = '';
                }, 5000);
            }
        }
        
        function showSuccessMessage(details) {
            const modal = document.getElementById('success-modal');
            if (modal) {
                // Use style.display instead of classes
                modal.style.display = 'flex';
            } else {
                showInlineMessage('Payment successful! Transaction ID: ' + details.id, 'success');
            }
        }

        function recordTransaction(details, amount, description) {
            const transaction = {
                transactionId: details.id,
                payerName: details.payer.name.given_name + ' ' + details.payer.name.surname,
                payerEmail: details.payer.email_address,
                amount: amount,
                description: description,
                status: details.status,
                timestamp: new Date().toISOString(),
                type: 'collymore-payment',
                category: 'personal',
                invoiceNumber: window.currentInvoice ? window.currentInvoice.number : null
            };
            
            localStorage.setItem('personal-transaction-' + details.id, JSON.stringify(transaction));
            console.log('Payment recorded:', transaction);
        }

        function downloadInvoice() {
            if (!window.currentInvoice) return;
            
            const invoice = window.currentInvoice;
            const invoiceText = `INVOICE\n\nCollymore Consulting\nInvoice #: ${invoice.number}\nDate: ${new Date(invoice.date).toLocaleDateString()}\n\nBill To:\n${invoice.client}\n\nService: ${invoice.service}\nAmount: $${parseFloat(invoice.amount).toFixed(2)}\n\nThank you for your business!\n\nCollymore Consulting\ncylton@cylton.com`;
            
            const blob = new Blob([invoiceText], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Invoice-${invoice.number}.txt`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function showSuccessModal() {
            document.getElementById('success-modal').style.display = 'flex';
        }

        function closeSuccessModal() {
            document.getElementById('success-modal').style.display = 'none';
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Close modal when clicking outside
        document.getElementById('success-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeSuccessModal();
            }
        });
        
        // Admin functionality
        document.addEventListener('DOMContentLoaded', function() {
            checkAdminStatus();
        });
        
        function checkAdminStatus() {
            const isAdmin = localStorage.getItem('sirsi-admin-session') === 'active';
            const adminNav = document.getElementById('admin-nav');
            
            if (adminNav) {
                if (isAdmin) {
                    // adminNav.classList.remove('hidden');
                    adminNav.classList.add('flex');
                } else {
                    // adminNav.classList.add('hidden');
                    adminNav.classList.remove('flex');
                }
            }
        }
        
        function showAdminLogin() {
            // Create inline admin login instead of browser prompt
            showInlineMessage('Admin login feature temporarily disabled for security', 'info');
        }
        
        function adminLogout() {
            localStorage.removeItem('sirsi-admin-session');
            checkAdminStatus();
            showInlineMessage('Logged out of admin mode', 'info');
        }
        
        // Apple Pay functions
        function showApplePayButton(show) {
            const applePayButton = document.getElementById('apple-pay-button');
            const availability = checkApplePayAvailability();
            
            if (show && availability.available) {
                applePayButton.style.display = 'block';
                
                // Update button text based on availability type
                const button = document.getElementById('apple-pay-btn');
                const buttonText = button.querySelector('span');
                
                if (availability.type === 'direct') {
                    buttonText.textContent = 'Pay with Apple Pay';
                } else if (availability.type === 'qr') {
                    buttonText.textContent = 'Apple Pay (QR Code)';
                }
                
                button.onclick = function() {
                    handleApplePay(availability.type);
                };
            } else {
                applePayButton.style.display = 'none';
            }
        }
        
        function handleApplePay(type) {
            // Check if user is registered
            if (registrationRequired) {
                showInlineMessage('Please create an account or continue as a guest to proceed.', 'info');
                document.getElementById('account-section').scrollIntoView({ behavior: 'smooth' });
                return;
            }
            
            const currentAmount = parseFloat(document.getElementById('payment-amount').value) || 0;
            if (currentAmount < 1) {
                highlightAmountField();
                return;
            }
            
            if (type === 'direct') {
                handleDirectApplePay();
            } else if (type === 'qr') {
                handleApplePayQR();
            }
        }
        
        function handleDirectApplePay() {
            const paymentRequest = {
                countryCode: 'US',
                currencyCode: 'USD',
                supportedNetworks: ['visa', 'masterCard', 'amex', 'discover'],
                merchantCapabilities: ['supports3DS'],
                total: {
                    label: currentDescription || 'Payment to SirsiNexus',
                    amount: currentAmount.toFixed(2)
                }
            };
            
            const session = new ApplePaySession(3, paymentRequest);
            
            session.onvalidatemerchant = function(event) {
                // In a real implementation, you'd validate with your server
                console.log('Apple Pay merchant validation needed');
                session.abort();
                showInlineMessage('Apple Pay setup required - contact support', 'error');
            };
            
            session.onpaymentauthorized = function(event) {
                // Ensure we have a user account (should be created during registration)
                if (!currentUser) {
                    console.error('No user account found during Apple Pay processing');
                    session.completePayment(ApplePaySession.STATUS_FAILURE);
                    showInlineMessage('Registration required. Please reload and create an account.', 'error');
                    return;
                }
                
                // Get payment data
                let amount, description;
                if (currentInvoice) {
                    amount = parseFloat(document.getElementById('invoice-payment-amount').value) || parseFloat(currentInvoice.amount);
                    description = document.getElementById('invoice-payment-description').value || `Invoice ${currentInvoice.number} - ${currentInvoice.service}`;
                } else {
                    amount = parseFloat(document.getElementById('payment-amount').value) || currentAmount;
                    description = document.getElementById('payment-description').value || currentDescription || 'Apple Pay Payment to SirsiNexus';
                }
                
                // Record comprehensive transaction in SirsiNexus system
                const applePayTransactionId = 'apple-pay-' + Date.now();
                const sirsiTransaction = accountManager.recordTransaction({
                    type: 'payment',
                    status: 'completed',
                    amount: amount,
                    description: description,
                    paymentMethod: 'apple_pay',
                    paymentProcessor: 'apple_pay',
                    processorTransactionId: applePayTransactionId,
                    payerName: 'Apple Pay User',
                    payerEmail: 'applepay-user@sirsinexus.com',
                    payerPhone: '',
                    payerAddress: {},
                    feeStructure: 'apple_pay_standard'
                });
                
                console.log('Apple Pay transaction recorded:', sirsiTransaction.transactionId);
                console.log('User account:', currentUser.userId);
                
                // Process payment with your payment processor
                session.completePayment(ApplePaySession.STATUS_SUCCESS);
                showSuccessMessage({id: applePayTransactionId});
            };
            
            session.begin();
        }
        
        function handleApplePayQR() {
            showApplePayQRModal();
        }
        
        function showApplePayQRModal() {
            const modal = createApplePayQRModal();
            document.body.appendChild(modal);
            modal.classList.add('flex');
            
            // Generate QR code data (in real implementation, get this from your server)
            const paymentData = {
                amount: currentAmount,
                currency: 'USD',
                description: currentDescription,
                merchantId: 'merchant.sirsinexus.com',
                timestamp: Date.now()
            };
            
            // Create payment URL for QR code
            const baseUrl = window.location.origin + window.location.pathname;
            const paymentUrl = `${baseUrl}?applePay=${encodeURIComponent(JSON.stringify(paymentData))}`;
            
            // Generate QR code
            generateQRCode(paymentUrl, 'apple-pay-qr-code');
            
            // Auto-close after 5 minutes
            setTimeout(() => {
                if (modal.parentNode) {
                    modal.remove();
                }
            }, 300000);
        }
        
        function createApplePayQRModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-slate-800 rounded-2xl p-8 max-w-md mx-4 text-center">
                    <div class="mb-6">
                        <div class="w-16 h-16 bg-black rounded-2xl flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-white" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
                            </svg>
                        </div>
                        <h3 class="text-2xl font-bold text-slate-900 dark:text-slate-100 mb-2">Apple Pay QR Code</h3>
                        <p class="text-slate-600 dark:text-slate-400 mb-4">
                            Scan this QR code with your iPhone or iPad camera to pay with Apple Pay
                        </p>
                    </div>
                    
                    <div class="bg-white rounded-2xl p-6 mb-6 border-2 border-slate-200">
                        <div id="apple-pay-qr-code" class="flex justify-center"></div>
                    </div>
                    
                    <div class="bg-slate-50 dark:bg-slate-700 rounded-xl p-4 mb-6">
                        <div class="text-sm text-slate-700 dark:text-slate-300">
                            <div class="flex justify-between items-center mb-2">
                                <span>Amount:</span>
                                <span class="font-semibold">$${currentAmount.toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span>Description:</span>
                                <span class="font-semibold">${currentDescription}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 dark:bg-blue-900/20 rounded-xl p-4 mb-6">
                        <div class="flex items-start gap-3">
                            <div class="bg-blue-600 rounded-full p-1 flex-shrink-0 mt-0.5">
                                <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="text-left">
                                <p class="text-sm font-medium text-blue-900 dark:text-blue-100 mb-1">How to pay:</p>
                                <ol class="text-xs text-blue-800 dark:text-blue-200 space-y-1">
                                    <li>1. Open Camera on your iPhone/iPad</li>
                                    <li>2. Point camera at the QR code</li>
                                    <li>3. Tap the Apple Pay notification</li>
                                    <li>4. Complete payment with Face ID/Touch ID</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-3">
                        <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-slate-200 dark:bg-slate-600 text-slate-800 dark:text-slate-200 py-3 px-6 rounded-xl font-medium hover:bg-slate-300 dark:hover:bg-slate-500 transition-colors">
                            Cancel
                        </button>
                        <button onclick="simulateQRPaymentSuccess()" class="flex-1 bg-green-600 text-white py-3 px-6 rounded-xl font-medium hover:bg-green-700 transition-colors">
                            Simulate Payment
                        </button>
                    </div>
                </div>
            `;
            
            // Close modal when clicking outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            return modal;
        }
        
        function generateQRCode(text, elementId) {
            const qrContainer = document.getElementById(elementId);
            if (!qrContainer) return;
            
            // Clear existing QR code
            qrContainer.innerHTML = '';
            
            // Check if QRCode library is loaded
            if (typeof QRCode !== 'undefined') {
                try {
                    // Use the QRCode library to generate a proper QR code
                    QRCode.toCanvas(qrContainer, text, {
                        width: 200,
                        height: 200,
                        color: {
                            dark: '#000000',
                            light: '#FFFFFF'
                        },
                        margin: 2,
                        errorCorrectionLevel: 'M'
                    }, function (error) {
                        if (error) {
                            console.error('QR Code generation error:', error);
                            // Fallback to showing the text as a link
                            qrContainer.innerHTML = `
                                <div class="text-center p-4 bg-red-50 rounded-lg border border-red-200">
                                    <p class="text-red-600 text-sm mb-2">QR Code generation failed</p>
                                    <a href="${text}" target="_blank" class="text-blue-600 underline text-xs break-all">${text}</a>
                                </div>
                            `;
                        }
                    });
                } catch (error) {
                    console.error('QRCode library error:', error);
                    // Fallback display
                    qrContainer.innerHTML = `
                        <div class="text-center p-4 bg-gray-50 rounded-lg border border-gray-200">
                            <p class="text-gray-600 text-sm mb-2">QR Code unavailable</p>
                            <a href="${text}" target="_blank" class="text-blue-600 underline text-xs break-all">${text}</a>
                        </div>
                    `;
                }
            } else {
                // QRCode library not loaded, show fallback
                qrContainer.innerHTML = `
                    <div class="text-center p-4 bg-amber-50 rounded-lg border border-amber-200">
                        <p class="text-amber-600 text-sm mb-2">QR Code library loading...</p>
                        <a href="${text}" target="_blank" class="text-blue-600 underline text-xs break-all">${text}</a>
                    </div>
                `;
            }
        }
        
        function simulateQRPaymentSuccess() {
            // Close QR modal
            const qrModal = document.querySelector('.fixed');
            if (qrModal) {
                qrModal.remove();
            }
            
            // Show processing message
            showInlineMessage('Processing Apple Pay payment...', 'info');
            
            // Simulate payment processing
            setTimeout(() => {
                // Ensure we have a user account (should be created during registration)
                if (!currentUser) {
                    console.error('No user account found during Apple Pay QR processing');
                    showInlineMessage('Registration required. Please reload and create an account.', 'error');
                    return;
                }
                
                // Get payment data from either invoice or custom payment
                let amount, description;
                if (currentInvoice) {
                    amount = parseFloat(document.getElementById('invoice-payment-amount').value) || parseFloat(currentInvoice.amount);
                    description = document.getElementById('invoice-payment-description').value || `Invoice ${currentInvoice.number} - ${currentInvoice.service}`;
                } else {
                    amount = parseFloat(document.getElementById('payment-amount').value) || currentAmount;
                    description = document.getElementById('payment-description').value || currentDescription || 'Apple Pay Payment to SirsiNexus';
                }
                
                // Record comprehensive transaction in SirsiNexus system
                const applePayTransactionId = 'apple-pay-qr-' + Date.now();
                const sirsiTransaction = accountManager.recordTransaction({
                    type: 'payment',
                    status: 'completed',
                    amount: amount,
                    description: description,
                    paymentMethod: 'apple_pay',
                    paymentProcessor: 'apple_pay',
                    processorTransactionId: applePayTransactionId,
                    payerName: 'Apple Pay User',
                    payerEmail: 'applepay-user@sirsinexus.com',
                    payerPhone: '',
                    payerAddress: {},
                    feeStructure: 'apple_pay_standard'
                });
                
                console.log('Apple Pay transaction recorded:', sirsiTransaction.transactionId);
                console.log('User account:', currentUser.userId);
                
                showSuccessMessage({id: applePayTransactionId});
            }, 1000);
        }
        
        // PayPal Fee Calculation System
        // Based on PayPal Standard Rates for Receiving Domestic Transactions (US)
        
        function calculatePayPalFees(amount) {
            // PayPal fee structure (as of 2024):
            // - Standard Credit/Debit Cards: 2.99% + $0.49 fixed fee
            // - PayPal Checkout: 3.49% + $0.49 fixed fee 
            // - PayPal Guest Checkout: 3.49% + $0.49 fixed fee
            // - QR Code Transactions: 2.29% + $0.10 fixed fee
            // - Venmo: 3.49% + $0.49 fixed fee
            // - Alternative Payment Methods: Varies (APM Transaction Rates Apply)
            // - Send/Receive Money for Goods and Services: 2.99%
            // - PayPal Pay Later options: 4.99% + $0.49 fixed fee
            // - All Other Commercial Transactions: 3.49% + $0.49 fixed fee
            
            const fees = {
                standardCard: {
                    rate: 0.0299,
                    fixedFee: 0.49,
                    name: 'Credit/Debit Cards',
                    description: '2.99% + $0.49'
                },
                paypalCheckout: {
                    rate: 0.0349,
                    fixedFee: 0.49,
                    name: 'PayPal Account',
                    description: '3.49% + $0.49'
                },
                qrCode: {
                    rate: 0.0229,
                    fixedFee: 0.10,
                    name: 'QR Code Payment',
                    description: '2.29% + $0.10'
                },
                venmo: {
                    rate: 0.0349,
                    fixedFee: 0.49,
                    name: 'Venmo',
                    description: '3.49% + $0.49'
                },
                goodsServices: {
                    rate: 0.0299,
                    fixedFee: 0.00,
                    name: 'Goods & Services',
                    description: '2.99%'
                },
                payLater: {
                    rate: 0.0499,
                    fixedFee: 0.49,
                    name: 'Pay Later Options',
                    description: '4.99% + $0.49'
                },
                commercial: {
                    rate: 0.0349,
                    fixedFee: 0.49,
                    name: 'Other Commercial',
                    description: '3.49% + $0.49'
                }
            };
            
            // Calculate fees for each method
            const calculations = {};
            
            Object.keys(fees).forEach(key => {
                const fee = fees[key];
                const percentageFee = amount * fee.rate;
                const totalFee = percentageFee + fee.fixedFee;
                const totalAmount = amount + totalFee;
                
                calculations[key] = {
                    ...fee,
                    percentageFee: Math.round(percentageFee * 100) / 100,
                    fixedFee: fee.fixedFee,
                    totalFee: Math.round(totalFee * 100) / 100,
                    totalAmount: Math.round(totalAmount * 100) / 100
                };
            });
            
            return calculations;
        }
        
        function getRecommendedFeeStructure(amount) {
            // Return the most common fee structure (standard commercial transaction)
            const fees = calculatePayPalFees(amount);
            return fees.commercial; // 3.49% + $0.49 covers most payment methods
        }
        
        function calculateAndDisplayFees(amount, mode) {
            const feeData = getRecommendedFeeStructure(amount);
            
            // Update global variables
            currentAmount = amount;
            currentFeeAmount = feeData.totalFee;
            currentTotalAmount = feeData.totalAmount;
            
            // Show fee breakdown
            showFeeBreakdown(feeData, amount, mode);
        }
        
        function showFeeBreakdown(feeData, subtotal, mode) {
            const breakdownId = mode === 'invoice' ? 'invoice-fee-breakdown' : 'fee-breakdown';
            const detailsId = mode === 'invoice' ? 'invoice-fee-details' : 'fee-details';
            const subtotalId = mode === 'invoice' ? 'invoice-fee-subtotal' : 'fee-subtotal';
            const feeAmountId = mode === 'invoice' ? 'invoice-fee-amount' : 'fee-amount';
            const totalId = mode === 'invoice' ? 'invoice-fee-total' : 'fee-total';
            
            const breakdownDiv = document.getElementById(breakdownId);
            const detailsDiv = document.getElementById(detailsId);
            const subtotalSpan = document.getElementById(subtotalId);
            const feeAmountSpan = document.getElementById(feeAmountId);
            const totalSpan = document.getElementById(totalId);
            
            if (!breakdownDiv || !detailsDiv) return;
            
            // Show the breakdown section
            // breakdownDiv.classList.remove('hidden');
            
            // Populate fee details
            detailsDiv.innerHTML = `
                <div class="flex justify-between items-center text-amber-800 dark:text-amber-200">
                    <span>Processing Rate:</span>
                    <span>${feeData.description}</span>
                </div>
                <div class="flex justify-between items-center text-amber-800 dark:text-amber-200">
                    <span>Percentage Fee:</span>
                    <span>$${feeData.percentageFee.toFixed(2)}</span>
                </div>
                ${feeData.fixedFee > 0 ? `
                <div class="flex justify-between items-center text-amber-800 dark:text-amber-200">
                    <span>Fixed Fee:</span>
                    <span>$${feeData.fixedFee.toFixed(2)}</span>
                </div>
                ` : ''}
                <div class="text-xs text-amber-700 dark:text-amber-300 mt-2 p-2 bg-amber-100 dark:bg-amber-800 rounded">
                    <strong>Note:</strong> This covers most PayPal payment methods including credit cards, PayPal accounts, and alternative payment methods.
                </div>
            `;
            
            // Update summary amounts
            if (subtotalSpan) subtotalSpan.textContent = `$${subtotal.toFixed(2)}`;
            if (feeAmountSpan) feeAmountSpan.textContent = `$${feeData.totalFee.toFixed(2)}`;
            if (totalSpan) totalSpan.textContent = `$${feeData.totalAmount.toFixed(2)}`;
        }
        
        function hideFeeBreakdown(mode) {
            const breakdownId = mode === 'invoice' ? 'invoice-fee-breakdown' : 'fee-breakdown';
            const breakdownDiv = document.getElementById(breakdownId);
            
            if (breakdownDiv) {
                // breakdownDiv.classList.add('hidden');
            }
            
            // Reset fee amounts
            currentFeeAmount = 0;
            currentTotalAmount = 0;
        }
        
        // Google Pay functions
        function showGooglePayButton(show) {
            const googlePayButton = document.getElementById('google-pay-button');
            if (show) {
                googlePayButton.style.display = 'block';
                createGooglePayButton();
            } else {
                googlePayButton.style.display = 'none';
            }
        }
        
        function createGooglePayButton() {
            const container = document.getElementById('google-pay-button');
            container.innerHTML = '';
            
            // Create custom Google Pay button to match our design
            const customButton = document.createElement('button');
            customButton.className = 'payment-btn payment-btn--google flex items-center justify-center gap-3 shadow-lg';
            customButton.innerHTML = `
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                <span>Pay with Google Pay</span>
            `;
            customButton.onclick = handleGooglePay;
            
            container.appendChild(customButton);
        }
        
        function handleGooglePay() {
            // Check if user is registered
            if (registrationRequired) {
                showInlineMessage('Please create an account or continue as a guest to proceed.', 'info');
                document.getElementById('account-section').scrollIntoView({ behavior: 'smooth' });
                return;
            }
            
            const currentAmount = parseFloat(document.getElementById('payment-amount').value) || 0;
            if (currentAmount < 1) {
                highlightAmountField();
                return;
            }
            
            // Check if Google Pay is available
            if (!googlePayClient) {
                showInlineMessage('Google Pay is not available on this browser. Please try Chrome or use another payment method.', 'error');
                return;
            }
            
            const paymentDataRequest = {
                apiVersion: googlePayConfig.apiVersion,
                apiVersionMinor: googlePayConfig.apiVersionMinor,
                allowedPaymentMethods: googlePayConfig.allowedPaymentMethods,
                transactionInfo: {
                    totalPriceStatus: 'FINAL',
                    totalPrice: currentAmount.toFixed(2),
                    currencyCode: 'USD'
                },
                merchantInfo: {
                    merchantName: 'SirsiNexus'
                }
            };
            
            googlePayClient.loadPaymentData(paymentDataRequest)
                .then(function(paymentData) {
                    console.log('Google Pay success:', paymentData);
                    
                    // Ensure we have a user account (should be created during registration)
                    if (!currentUser) {
                        console.error('No user account found during Google Pay processing');
                        showInlineMessage('Registration required. Please reload and create an account.', 'error');
                        return;
                    }
                    
                    // Get payment data from either invoice or custom payment
                    let amount, description;
                    if (currentInvoice) {
                        amount = parseFloat(document.getElementById('invoice-payment-amount').value) || parseFloat(currentInvoice.amount);
                        description = document.getElementById('invoice-payment-description').value || `Invoice ${currentInvoice.number} - ${currentInvoice.service}`;
                    } else {
                        amount = parseFloat(document.getElementById('payment-amount').value) || currentAmount;
                        description = document.getElementById('payment-description').value || currentDescription || 'Google Pay Payment to SirsiNexus';
                    }
                    
                    // Record comprehensive transaction in SirsiNexus system
                    const googlePayTransactionId = 'google-pay-' + Date.now();
                    const sirsiTransaction = accountManager.recordTransaction({
                        type: 'payment',
                        status: 'completed',
                        amount: amount,
                        description: description,
                        paymentMethod: 'google_pay',
                        paymentProcessor: 'google_pay',
                        processorTransactionId: googlePayTransactionId,
                        payerName: 'Google Pay User',
                        payerEmail: 'googlepay-user@sirsinexus.com',
                        payerPhone: '',
                        payerAddress: {},
                        feeStructure: 'google_pay_standard'
                    });
                    
                    console.log('Google Pay transaction recorded:', sirsiTransaction.transactionId);
                    console.log('User account:', currentUser.userId);
                    
                    showSuccessMessage({id: googlePayTransactionId});
                })
                .catch(function(err) {
                    console.error('Google Pay error:', err);
                    if (err.statusCode === 'CANCELED') {
                        showInlineMessage('Google Pay payment was cancelled.', 'error');
                    } else {
                        showInlineMessage('Google Pay is not available on this device/browser. Please use another payment method.', 'error');
                    }
                });
        }
        
        // Unified Zelle Payment Functions
        function showZelleInvoiceDetails() {
            const detailsDiv = document.getElementById('invoice-zelle-details');
            if (detailsDiv) {
                // Scroll to the details section
                setTimeout(() => {
                    detailsDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
            }
        }
        
        function showZelleDetails() {
            const detailsDiv = document.getElementById('zelle-details');
            if (detailsDiv) {
                if (detailsDiv.style.display === 'none') {
                    detailsDiv.style.display = 'block';
                    // Scroll to the details section
                    setTimeout(() => {
                        detailsDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 100);
                } else {
                    detailsDiv.style.display = 'none';
                }
            }
        }
        
        function copyZelleInfoInvoice() {
            if (!currentInvoice) {
                alert('Please create an invoice first.');
                return;
            }
            
            const paymentAmountInput = document.getElementById('invoice-payment-amount');
            const amount = parseFloat(paymentAmountInput.value) || parseFloat(currentInvoice.amount) || 0;
            const invoiceNumber = currentInvoice.number;
            const description = `Invoice ${invoiceNumber} - ${currentInvoice.service}`;
            
            // Ensure we have a user account (should be created during registration)
            if (!currentUser) {
                console.error('No user account found during Zelle processing');
                showInlineMessage('Registration required. Please reload and create an account.', 'error');
                return;
            }
            
            // Record pending Zelle transaction in SirsiNexus system
            const zelleTransaction = accountManager.recordTransaction({
                type: 'payment',
                status: 'pending', // Will be updated when payment is confirmed
                amount: amount,
                description: description,
                paymentMethod: 'zelle',
                paymentProcessor: 'zelle_network',
                processorTransactionId: null, // Zelle doesn't provide immediate transaction ID
                payerName: 'Zelle User', // Will be updated when payment details are available
                payerEmail: 'pending@zelle.verification', // Placeholder
                payerPhone: '',
                payerAddress: {},
                feeStructure: 'zelle_no_fees'
            });
            
            console.log('Zelle transaction recorded as pending:', zelleTransaction.transactionId);
            
            const zelleInfo = `💜 ZELLE PAYMENT - NO FEES!

Invoice Payment Details:
• Invoice: ${invoiceNumber}
• Amount: $${amount.toFixed(2)} USD
• Recipient: cylton@cylton.com
• Service: ${currentInvoice.service}
• Transaction ID: ${zelleTransaction.transactionId}

Payment Instructions:
1. Open your bank's mobile app or Zelle® app
2. Send money to: cylton@cylton.com
3. Enter amount: $${amount.toFixed(2)}
4. Add note: "Invoice ${invoiceNumber}"

Benefits:
✓ Instant transfer (usually within minutes)
✓ Bank-level security and encryption
✓ Zero processing fees
✓ Available 24/7
✓ No account setup required

Questions? Contact: cylton@cylton.com

SirsiNexus - AI Infrastructure Solutions

Note: Your payment intent has been recorded in our system with Transaction ID: ${zelleTransaction.transactionId}. Once your Zelle payment is received, we'll update the status automatically.`;
            
            navigator.clipboard.writeText(zelleInfo).then(() => {
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '✅ Copied!';
                button.classList.remove('bg-purple-600', 'hover:bg-purple-700');
                button.classList.add('bg-green-600');
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.classList.remove('bg-green-600');
                    button.classList.add('bg-purple-600', 'hover:bg-purple-700');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy Zelle info: ', err);
                alert('Failed to copy. Please try again.');
            });
        }
        
        function copyZelleInfo() {
            // Check if user is registered
            if (registrationRequired) {
                showInlineMessage('Please create an account or continue as a guest to proceed.', 'info');
                document.getElementById('registration-form').scrollIntoView({ behavior: 'smooth' });
                return;
            }
            
            const amountInput = document.getElementById('payment-amount');
            const descInput = document.getElementById('payment-description');
            
            const amount = parseFloat(amountInput.value) || 0;
            const description = descInput.value || 'Payment to SirsiNexus';
            
            if (amount <= 0) {
                alert('Please enter a payment amount first.');
                highlightAmountField();
                return;
            }
            
            // Create or get user account for Zelle payment tracking
            if (!currentUser) {
                currentUser = accountManager.createGuestAccount({
                    payerEmail: 'zelle-user@sirsinexus.com', // Placeholder since we don't have their email
                    firstName: 'Zelle',
                    lastName: 'User'
                });
            }
            
            // Record pending Zelle transaction in SirsiNexus system
            const zelleTransaction = accountManager.recordTransaction({
                type: 'payment',
                status: 'pending', // Will be updated when payment is confirmed
                amount: amount,
                description: description,
                paymentMethod: 'zelle',
                paymentProcessor: 'zelle_network',
                processorTransactionId: null, // Zelle doesn't provide immediate transaction ID
                payerName: 'Zelle User', // Will be updated when payment details are available
                payerEmail: 'pending@zelle.verification', // Placeholder
                payerPhone: '',
                payerAddress: {},
                feeStructure: 'zelle_no_fees'
            });
            
            console.log('Zelle transaction recorded as pending:', zelleTransaction.transactionId);
            
            const zelleInfo = `💜 ZELLE PAYMENT - NO FEES!\n\nPayment Details:\n• Amount: $${amount.toFixed(2)} USD\n• Description: ${description}\n• Recipient: cylton@cylton.com\n• Transaction ID: ${zelleTransaction.transactionId}\n\nPayment Instructions:\n1. Open your bank's mobile app or Zelle® app\n2. Send money to: cylton@cylton.com\n3. Enter amount: $${amount.toFixed(2)}\n4. Add note: "${description}"\n\nBenefits:\n✓ Instant transfer (usually within minutes)\n✓ Bank-level security and encryption\n✓ Zero processing fees\n✓ Available 24/7\n✓ No account setup required\n\nQuestions? Contact: cylton@cylton.com\n\nSirsiNexus - AI Infrastructure Solutions\n\nNote: Your payment intent has been recorded in our system with Transaction ID: ${zelleTransaction.transactionId}. Once your Zelle payment is received, we'll update the status automatically.`;
            
            navigator.clipboard.writeText(zelleInfo).then(() => {
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '✅ Copied!';
                button.classList.remove('bg-purple-600', 'hover:bg-purple-700');
                button.classList.add('bg-green-600');
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.classList.remove('bg-green-600');
                    button.classList.add('bg-purple-600', 'hover:bg-purple-700');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy Zelle info: ', err);
                alert('Failed to copy. Please try again.');
            });
        }
    </script>
</body>
</html>
