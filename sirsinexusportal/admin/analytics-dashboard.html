<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard - SirsiNexus Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics-compat.js"></script>
    
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Performance & Error Tracking -->
    <script src="../assets/js/performance-monitor.js"></script>
    <script src="../assets/js/error-tracker.js"></script>
    
    <style>
        .metric-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .chart-container {
            position: relative;
            height: 300px;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .loading-pulse {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <!-- Header -->
    <header class="bg-gray-800 border-b border-gray-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <img src="../assets/images/Sirsi_Logo_300ppi_cguiyg.png" alt="Sirsi" class="h-8 w-8 mr-3">
                    <h1 class="text-xl font-bold">Analytics Dashboard</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="refreshData()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                    <button onclick="exportData()" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg transition">
                        <i class="fas fa-download mr-2"></i>Export
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Date Range Selector -->
        <div class="bg-gray-800 rounded-lg p-4 mb-6">
            <div class="flex flex-wrap items-center gap-4">
                <select id="dateRange" onchange="updateDateRange()" class="bg-gray-700 text-white px-4 py-2 rounded-lg">
                    <option value="today">Today</option>
                    <option value="yesterday">Yesterday</option>
                    <option value="week" selected>Last 7 Days</option>
                    <option value="month">Last 30 Days</option>
                    <option value="quarter">Last 90 Days</option>
                    <option value="custom">Custom Range</option>
                </select>
                <div id="customDateRange" class="hidden flex gap-2">
                    <input type="date" id="startDate" class="bg-gray-700 text-white px-4 py-2 rounded-lg">
                    <input type="date" id="endDate" class="bg-gray-700 text-white px-4 py-2 rounded-lg">
                    <button onclick="applyCustomRange()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg">Apply</button>
                </div>
                <div class="ml-auto text-sm text-gray-400">
                    Last updated: <span id="lastUpdated">-</span>
                </div>
            </div>
        </div>

        <!-- Key Metrics Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Total Users -->
            <div class="metric-card bg-gray-800 rounded-lg p-6 border border-gray-700">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-gray-400 text-sm font-medium">Total Users</h3>
                    <i class="fas fa-users text-blue-500"></i>
                </div>
                <div class="text-3xl font-bold" id="totalUsers">
                    <span class="loading-pulse">-</span>
                </div>
                <div class="text-sm mt-2">
                    <span id="userGrowth" class="text-green-400">-</span> vs last period
                </div>
            </div>

            <!-- Active Users -->
            <div class="metric-card bg-gray-800 rounded-lg p-6 border border-gray-700">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-gray-400 text-sm font-medium">Active Users</h3>
                    <i class="fas fa-user-check text-green-500"></i>
                </div>
                <div class="text-3xl font-bold" id="activeUsers">
                    <span class="loading-pulse">-</span>
                </div>
                <div class="text-sm mt-2">
                    <span id="activeRate" class="text-gray-400">-</span> activity rate
                </div>
            </div>

            <!-- Revenue -->
            <div class="metric-card bg-gray-800 rounded-lg p-6 border border-gray-700">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-gray-400 text-sm font-medium">Revenue</h3>
                    <i class="fas fa-dollar-sign text-yellow-500"></i>
                </div>
                <div class="text-3xl font-bold" id="totalRevenue">
                    <span class="loading-pulse">-</span>
                </div>
                <div class="text-sm mt-2">
                    <span id="revenueGrowth" class="text-green-400">-</span> vs last period
                </div>
            </div>

            <!-- Performance Score -->
            <div class="metric-card bg-gray-800 rounded-lg p-6 border border-gray-700">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-gray-400 text-sm font-medium">Performance Score</h3>
                    <i class="fas fa-tachometer-alt text-purple-500"></i>
                </div>
                <div class="text-3xl font-bold" id="performanceScore">
                    <span class="loading-pulse">-</span>
                </div>
                <div class="text-sm mt-2">
                    <span id="avgLoadTime" class="text-gray-400">-</span> avg load time
                </div>
            </div>
        </div>

        <!-- Charts Row 1 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- User Growth Chart -->
            <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                <h3 class="text-lg font-semibold mb-4">User Growth</h3>
                <div class="chart-container">
                    <canvas id="userGrowthChart"></canvas>
                </div>
            </div>

            <!-- Revenue Chart -->
            <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                <h3 class="text-lg font-semibold mb-4">Revenue Trend</h3>
                <div class="chart-container">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Charts Row 2 -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- Traffic Sources -->
            <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                <h3 class="text-lg font-semibold mb-4">Traffic Sources</h3>
                <div class="chart-container">
                    <canvas id="trafficSourcesChart"></canvas>
                </div>
            </div>

            <!-- Device Breakdown -->
            <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                <h3 class="text-lg font-semibold mb-4">Device Types</h3>
                <div class="chart-container">
                    <canvas id="deviceChart"></canvas>
                </div>
            </div>

            <!-- Browser Distribution -->
            <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                <h3 class="text-lg font-semibold mb-4">Browser Usage</h3>
                <div class="chart-container">
                    <canvas id="browserChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Performance Metrics -->
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700 mb-8">
            <h3 class="text-lg font-semibold mb-4">Performance Metrics</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <div class="text-sm text-gray-400">LCP (Largest Contentful Paint)</div>
                    <div class="text-2xl font-bold" id="lcpMetric">-</div>
                </div>
                <div>
                    <div class="text-sm text-gray-400">FID (First Input Delay)</div>
                    <div class="text-2xl font-bold" id="fidMetric">-</div>
                </div>
                <div>
                    <div class="text-sm text-gray-400">CLS (Cumulative Layout Shift)</div>
                    <div class="text-2xl font-bold" id="clsMetric">-</div>
                </div>
                <div>
                    <div class="text-sm text-gray-400">TTFB (Time to First Byte)</div>
                    <div class="text-2xl font-bold" id="ttfbMetric">-</div>
                </div>
            </div>
        </div>

        <!-- Recent Activity Table -->
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <h3 class="text-lg font-semibold mb-4">Recent Activity</h3>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-gray-700">
                            <th class="text-left py-3 px-4">Time</th>
                            <th class="text-left py-3 px-4">User</th>
                            <th class="text-left py-3 px-4">Action</th>
                            <th class="text-left py-3 px-4">Details</th>
                            <th class="text-left py-3 px-4">Status</th>
                        </tr>
                    </thead>
                    <tbody id="activityTable" class="text-gray-300">
                        <tr>
                            <td colspan="5" class="text-center py-8 text-gray-500">Loading activity...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDFd4RAvVZWy3G1geLudrq4KgDDsGr-jb8",
            authDomain: "sirsi-nexus-live.firebaseapp.com",
            databaseURL: "https://sirsi-nexus-live-default-rtdb.firebaseio.com",
            projectId: "sirsi-nexus-live",
            storageBucket: "sirsi-nexus-live.firebasestorage.app",
            messagingSenderId: "210890802638",
            appId: "1:210890802638:web:9b721753a295620422179f"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const analytics = firebase.analytics();

        // Chart instances
        let userGrowthChart, revenueChart, trafficSourcesChart, deviceChart, browserChart;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            initializeCharts();
            loadAnalyticsData();
            startRealTimeUpdates();
        });

        // Check authentication
        function checkAuth() {
            auth.onAuthStateChanged((user) => {
                if (!user) {
                    window.location.href = '../login.html';
                    return;
                }
                
                // Check if user is admin
                db.collection('users').doc(user.uid).get().then((doc) => {
                    if (!doc.exists || doc.data().role !== 'admin') {
                        alert('Admin access required');
                        window.location.href = '../dashboard.html';
                    }
                });
            });
        }

        // Initialize charts
        function initializeCharts() {
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: '#9CA3AF'
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: '#374151'
                        },
                        ticks: {
                            color: '#9CA3AF'
                        }
                    },
                    y: {
                        grid: {
                            color: '#374151'
                        },
                        ticks: {
                            color: '#9CA3AF'
                        }
                    }
                }
            };

            // User Growth Chart
            userGrowthChart = new Chart(document.getElementById('userGrowthChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Total Users',
                        data: [],
                        borderColor: '#3B82F6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Active Users',
                        data: [],
                        borderColor: '#10B981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4
                    }]
                },
                options: chartOptions
            });

            // Revenue Chart
            revenueChart = new Chart(document.getElementById('revenueChart'), {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Revenue ($)',
                        data: [],
                        backgroundColor: '#F59E0B'
                    }]
                },
                options: chartOptions
            });

            // Traffic Sources Chart
            trafficSourcesChart = new Chart(document.getElementById('trafficSourcesChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Direct', 'Organic', 'Social', 'Referral', 'Other'],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#3B82F6',
                            '#10B981',
                            '#F59E0B',
                            '#EF4444',
                            '#8B5CF6'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#9CA3AF'
                            }
                        }
                    }
                }
            });

            // Device Chart
            deviceChart = new Chart(document.getElementById('deviceChart'), {
                type: 'pie',
                data: {
                    labels: ['Desktop', 'Mobile', 'Tablet'],
                    datasets: [{
                        data: [],
                        backgroundColor: ['#6366F1', '#EC4899', '#14B8A6']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#9CA3AF'
                            }
                        }
                    }
                }
            });

            // Browser Chart
            browserChart = new Chart(document.getElementById('browserChart'), {
                type: 'pie',
                data: {
                    labels: ['Chrome', 'Safari', 'Firefox', 'Edge', 'Other'],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#3B82F6',
                            '#6B7280',
                            '#F97316',
                            '#10B981',
                            '#8B5CF6'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#9CA3AF'
                            }
                        }
                    }
                }
            });
        }

        // Load analytics data
        async function loadAnalyticsData() {
            try {
                // Get date range
                const range = getDateRange();
                
                // Load user metrics
                const users = await db.collection('users')
                    .where('createdAt', '>=', range.start)
                    .where('createdAt', '<=', range.end)
                    .get();
                
                document.getElementById('totalUsers').innerHTML = users.size.toLocaleString();
                
                // Calculate active users (logged in within last 7 days)
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                
                let activeCount = 0;
                users.forEach(doc => {
                    const lastActive = doc.data().lastActive?.toDate();
                    if (lastActive && lastActive > sevenDaysAgo) {
                        activeCount++;
                    }
                });
                
                document.getElementById('activeUsers').innerHTML = activeCount.toLocaleString();
                document.getElementById('activeRate').innerHTML = `${((activeCount / users.size) * 100).toFixed(1)}%`;
                
                // Load performance metrics
                if (window.performanceMonitor) {
                    const perfSummary = window.performanceMonitor.getSummary();
                    const score = window.performanceMonitor.getScore();
                    
                    document.getElementById('performanceScore').innerHTML = score;
                    
                    if (perfSummary.webVitals.lcp) {
                        document.getElementById('lcpMetric').innerHTML = `${perfSummary.webVitals.lcp.value.toFixed(0)}ms`;
                    }
                    if (perfSummary.webVitals.fid) {
                        document.getElementById('fidMetric').innerHTML = `${perfSummary.webVitals.fid.value.toFixed(0)}ms`;
                    }
                    if (perfSummary.webVitals.cls) {
                        document.getElementById('clsMetric').innerHTML = perfSummary.webVitals.cls.value.toFixed(3);
                    }
                    if (perfSummary.webVitals.ttfb) {
                        document.getElementById('ttfbMetric').innerHTML = `${perfSummary.webVitals.ttfb.value.toFixed(0)}ms`;
                    }
                    
                    document.getElementById('avgLoadTime').innerHTML = 
                        `${(perfSummary.navigation.pageLoad || 0).toFixed(0)}ms`;
                }
                
                // Update charts with sample data
                updateCharts();
                
                // Update last updated time
                document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
                
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        // Update charts with data
        function updateCharts() {
            // Sample data for demonstration
            const last7Days = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                last7Days.push(date.toLocaleDateString('en', { month: 'short', day: 'numeric' }));
            }
            
            // User Growth Chart
            userGrowthChart.data.labels = last7Days;
            userGrowthChart.data.datasets[0].data = [120, 125, 130, 128, 135, 142, 150];
            userGrowthChart.data.datasets[1].data = [80, 82, 85, 84, 88, 92, 95];
            userGrowthChart.update();
            
            // Revenue Chart
            revenueChart.data.labels = last7Days;
            revenueChart.data.datasets[0].data = [1200, 1350, 1100, 1450, 1600, 1550, 1800];
            revenueChart.update();
            
            // Traffic Sources
            trafficSourcesChart.data.datasets[0].data = [35, 25, 20, 15, 5];
            trafficSourcesChart.update();
            
            // Device Types
            deviceChart.data.datasets[0].data = [60, 35, 5];
            deviceChart.update();
            
            // Browser Distribution
            browserChart.data.datasets[0].data = [45, 20, 15, 10, 10];
            browserChart.update();
        }

        // Get date range based on selection
        function getDateRange() {
            const select = document.getElementById('dateRange').value;
            const end = new Date();
            const start = new Date();
            
            switch(select) {
                case 'today':
                    start.setHours(0, 0, 0, 0);
                    break;
                case 'yesterday':
                    start.setDate(start.getDate() - 1);
                    start.setHours(0, 0, 0, 0);
                    end.setDate(end.getDate() - 1);
                    end.setHours(23, 59, 59, 999);
                    break;
                case 'week':
                    start.setDate(start.getDate() - 7);
                    break;
                case 'month':
                    start.setDate(start.getDate() - 30);
                    break;
                case 'quarter':
                    start.setDate(start.getDate() - 90);
                    break;
            }
            
            return { start, end };
        }

        // Update date range
        function updateDateRange() {
            const select = document.getElementById('dateRange');
            const customRange = document.getElementById('customDateRange');
            
            if (select.value === 'custom') {
                customRange.classList.remove('hidden');
            } else {
                customRange.classList.add('hidden');
                loadAnalyticsData();
            }
        }

        // Apply custom date range
        function applyCustomRange() {
            loadAnalyticsData();
        }

        // Refresh data
        function refreshData() {
            loadAnalyticsData();
        }

        // Export data
        function exportData() {
            const data = {
                exportDate: new Date().toISOString(),
                metrics: {
                    totalUsers: document.getElementById('totalUsers').textContent,
                    activeUsers: document.getElementById('activeUsers').textContent,
                    revenue: document.getElementById('totalRevenue').textContent,
                    performanceScore: document.getElementById('performanceScore').textContent
                },
                performance: window.performanceMonitor?.getSummary() || {},
                errors: window.errorTracker?.getSummary() || {}
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `analytics-export-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Start real-time updates
        function startRealTimeUpdates() {
            // Update every 30 seconds
            setInterval(() => {
                loadAnalyticsData();
            }, 30000);
        }
    </script>
</body>
</html>
